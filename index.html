<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>화랑FC 관리 시스템</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin:0; padding:0; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; }
    .icon { display:inline-block; width:1rem; height:1rem; vertical-align:middle; }
    .icon-lg { width:1.5rem; height:1.5rem; }
    @media (min-width:640px){ .icon-lg{ width:2rem; height:2rem; } }

    /* Pitch */
    .pitch{ position:relative; min-height:420px; background:linear-gradient(#bfe3bf,#9bd49b); border-radius:14px; overflow:hidden; box-shadow:inset 0 0 0 2px rgba(255,255,255,.6) }
    @media (min-width:640px){ .pitch{ min-height:640px; } }
    .pitch .half-line{ position:absolute; top:50%; left:0; right:0; height:2px; background:rgba(255,255,255,.9); transform:translateY(-50%) }
    .pitch .center-circle{ position:absolute; top:50%; left:50%; width:120px; height:120px; border:2px solid rgba(255,255,255,.9); border-radius:50%; transform:translate(-50%,-50%) }
    @media (min-width:640px){ .pitch .center-circle{ width:160px; height:160px } }
    .pitch .center-dot{ position:absolute; top:50%; left:50%; width:8px; height:8px; background:#fff; border-radius:50%; transform:translate(-50%,-50%) }
    .pitch .box{ position:absolute; left:50%; width:220px; height:100px; border:2px solid rgba(255,255,255,.9); transform:translateX(-50%); background:rgba(255,255,255,.06) }
    @media (min-width:640px){ .pitch .box{ width:260px; height:140px } }
    .pitch .box.top{ top:10px } .pitch .box.bottom{ bottom:10px }

    /* DnD */
    .player-chip.dragging{ opacity:.55 }
    .drop-slot.drag-over{ outline:2px dashed rgba(59,130,246,.9); outline-offset:4px }

    /* Mobile nav scroll */
    .nav-scroll{ scrollbar-width:none; -ms-overflow-style:none }
    .nav-scroll::-webkit-scrollbar{ display:none }

    /* 균등 그리드 - 개선된 버전 */
    .row-grid { 
      display:grid; 
      align-items:center; 
      width: 100%;
      gap: 8px;
    }
    .row-grid.cols-1{ grid-template-columns: 1fr; }
    .row-grid.cols-2{ grid-template-columns: 1fr 1fr; }
    .row-grid.cols-3{ grid-template-columns: 1fr 1fr 1fr; }
    .row-grid.cols-4{ grid-template-columns: 1fr 1fr 1fr 1fr; }
    .row-grid.cols-5{ grid-template-columns: 1fr 1fr 1fr 1fr 1fr; }
    
    .row-grid .cell{ 
      display:flex; 
      flex-direction:column; 
      align-items:center; 
      justify-content:center;
      gap:4px; 
      min-height: 80px;
    }
    
    @media (min-width:640px) {
      .row-grid {
        gap: 12px;
      }
      .row-grid .cell {
        min-height: 100px;
      }
    }

    /* 미니 프리뷰 피치 - 개선된 스타일 */
    .mini-pitch{ 
      position:relative; 
      height:160px; 
      background:linear-gradient(#bfe3bf,#9bd49b); 
      border-radius:10px; 
      overflow:hidden; 
      box-shadow:inset 0 0 0 2px rgba(255,255,255,.5);
    }
    .mini-pitch .half-line{ position:absolute; top:50%; left:0; right:0; height:2px; background:rgba(255,255,255,.7); transform:translateY(-50%) }
    .mini-pitch .box{ position:absolute; left:50%; width:120px; height:52px; border:2px solid rgba(255,255,255,.7); transform:translateX(-50%); background:rgba(255,255,255,.06) }
    .mini-pitch .box.top{ top:6px } 
    .mini-pitch .box.bottom{ bottom:6px }
    .mini-row{ 
      position:absolute; 
      display:grid; 
      place-items:center; 
    }
    .mini-badge{ 
      font-size:10px; 
      line-height:1.2; 
      color:#fff; 
      background:rgba(59,130,246,.9); 
      padding:3px 6px; 
      border-radius:999px; 
      white-space:nowrap; 
      max-width:90px; 
      overflow:hidden; 
      text-overflow:ellipsis; 
      font-weight: 500;
      border: 1px solid rgba(255,255,255,0.3);
    }

    /* 길게 누르기 힌트 감안한 선택 방지 */
    .no-select{ user-select:none; -webkit-user-select:none; }
    
    /* 플레이어 칩 호버 효과 개선 */
    .player-chip-field {
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .player-chip-field:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    /* 빈 슬롯 스타일 개선 */
    .empty-slot {
      border: 2px dashed rgba(255,255,255,0.4);
      background: rgba(255,255,255,0.1);
      transition: all 0.2s ease;
    }
    .empty-slot:hover {
      border-color: rgba(255,255,255,0.7);
      background: rgba(255,255,255,0.2);
    }
  </style>
</head>
<body>
<div id="root"></div>

<script>
// --- Google Sheets Configuration ---
const API_KEY = 'AIzaSyAxrFMgnW6NUu1zElfmPne5tanl0NEvdc0';
const CLIENT_ID = '564267897779-cjkimjreiscc6h2iobh30tue15o7aik8.apps.googleusercontent.com';
const SPREADSHEET_ID = '1-uK4oHEAPYCVg7H4_7CXgKfbAqlAfrQeIP188jhmSLg';
const DISCOVERY_DOCS = ['https://sheets.googleapis.com/$discovery/rest?version=v4'];
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

// --- STATE ---
let state = {
  activeTab: "dashboard",
  players: [], // Google Sheets 'Members' 시트에서 로드
  matches: [], // Google Sheets 'Matches' 시트에서 로드
  formation: {
    gk: [null], def: [null,null,null,null], dmf: [null,null], cmf: [null,null,null], amf: [null,null], fw: [null]
  },
  quarters: [null, null, null, null], // LocalStorage에만 저장
  currentQuarter: 1,
  newMatch: { opponent:"", location:"", date:"", result:"", goals:0, conceded:0, scorers:"" },
  draggedPlayer: null,
  saveStatus: "",
  playerSearch: "",
  ui: { pickerOpen:false, pickerPos:null, pickerSlot:null, pickerSearch:"" },
  isGapiLoaded: false,
  isGapiSignedIn: false,
};

const positionLabels = { gk: ['GK'], def: ['LB','CB','CB','RB'], dmf: ['DMF','DMF'], cmf: ['LM','CM','RM'], amf: ['LW','RW'], fw: ['ST'] };
const rowOrder = ['fw','amf','cmf','dmf','def','gk'];
const icons = {
  plus:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>',
  users:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20v-2a4 4 0 00-4-4H7a4 4 0 00-4 4v2m14 0h3v-2a7 7 0 00-7-7M9 7a4 4 0 118 0 4 4 0 01-8 0z"/></svg>',
  calendar:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12"/></svg>',
  barChart:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19V10m-4 9V7m8 12v-4m4 4V4"/></svg>',
  target:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" stroke-width="2"/><circle cx="12" cy="12" r="5" stroke-width="2"/></svg>',
  shield:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 22s8-3 8-10V6l-8-4-8 4v6c0 7 8 10 8 10z"/></svg>',
  save:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 01-2 2H6a2 2 0 01-2-2V7a2 2 0 012-2h3"/></svg>',
  sync:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>',
  trash:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5-4h4a2 2 0 012 2v2H8V5a2 2 0 012-2z"/></svg>'
};

// --- RENDER/STATE ---
function render(){ document.getElementById('root').innerHTML = createApp(); }
function setState(p){ state = {...state, ...p}; render(); }

// --- UTILS ---
function sanitizeName(raw){
  if(!raw) return "";
  let s = String(raw).trim();
  s = s.replace(/^화랑[\s_\-]?/i, "");
  s = s.replace(/\s{2,}/g, " ");
  s = s.replace(/[^\p{L}\p{N}\s._-]/gu, "");
  return s.trim();
}
function safeJSON(s, fallback){ try{ return JSON.parse(s); }catch{ return fallback; } }
function deepCopyFormation(f){ return JSON.parse(JSON.stringify(f)); }

// --- GOOGLE SHEETS API ---
function handleClientLoad() {
  gapi.load('client:auth2', initGapiClient);
}

// --- GOOGLE SHEETS API ---
function handleClientLoad() {
  gapi.load('client:auth2', initGapiClient);
}

function initGapiClient() {
  gapi.client.init({
    apiKey: API_KEY,
    clientId: CLIENT_ID,
    discoveryDocs: DISCOVERY_DOCS,
    scope: SCOPES,
  }).then(() => {
    setState({ isGapiLoaded: true });
    gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
    updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
  }, (err) => {
    // 👇 이 부분을 수정하여 에러 내용을 콘솔에 명확하게 출력합니다.
    console.error("Google API 초기화 실패 - 상세 에러:", err);
    setState({ saveStatus: "❌ Google API 초기화 실패. 콘솔(F12)을 확인해주세요." });
  });
}

function updateSigninStatus(isSignedIn) {
  setState({ isGapiSignedIn: isSignedIn });
  if (isSignedIn) {
    loadAllDataFromSheets();
  }
}

function handleAuthClick() {
  gapi.auth2.getAuthInstance().signIn();
}

function handleSignoutClick() {
  gapi.auth2.getAuthInstance().signOut();
}

async function loadAllDataFromSheets() {
  setState({ saveStatus: "🔄 Google Sheets에서 데이터를 불러오는 중..." });
  try {
    // Load Members
    const membersResponse = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'Members!A2:B', // A열: 이름, B열: 포지션
    });
    const membersRows = membersResponse.result.values || [];
    const players = membersRows.map(row => ({
      id: Date.now() + Math.random(), // 임시 ID
      name: sanitizeName(row[0]),
      position: row[1] || 'MF',
      isPresent: false,
    }));

    // Load Matches
    const matchesResponse = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'Matches!A2:H', // A:ID, B:날짜, C:상대, D:장소, E:결과, F:득점, G:실점, H:득점자
    });
    const matchesRows = matchesResponse.result.values || [];
    const matches = matchesRows.map(row => ({
      id: row[0],
      date: row[1],
      opponent: row[2],
      location: row[3],
      result: row[4],
      goals: parseInt(row[5]) || 0,
      conceded: parseInt(row[6]) || 0,
      scorers: row[7] || '',
      score: `${row[5] || 0}-${row[6] || 0}`
    }));

    setState({ players, matches, saveStatus: "✅ 데이터 동기화 완료" });
    setTimeout(() => setState({ saveStatus: "" }), 2000);

  } catch (err) {
    console.error("Error loading data from sheets", err);
    setState({ saveStatus: "❌ 데이터 로딩 실패. 시트 이름과 권한을 확인하세요." });
  }
}

async function addMatchToSheet(matchData) {
  setState({ saveStatus: "⏳ 경기 기록을 저장 중..." });
  try {
    const newMatchId = Date.now().toString();
    const values = [[
      newMatchId,
      matchData.date,
      matchData.opponent,
      matchData.location,
      matchData.result,
      matchData.goals,
      matchData.conceded,
      matchData.scorers
    ]];
    
    await gapi.client.sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: 'Matches!A2:H',
      valueInputOption: 'USER_ENTERED',
      resource: { values }
    });

    // Add to local state
    const newMatch = { ...matchData, id: newMatchId, score: `${matchData.goals}-${matchData.conceded}` };
    setState({ 
      matches: [...state.matches, newMatch],
      newMatch: { opponent:"", location:"", date:"", result:"", goals:0, conceded:0, scorers:"" },
      saveStatus: "✅ 경기 기록이 저장되었습니다."
    });
    setTimeout(() => setState({ saveStatus: "" }), 2000);

  } catch (err) {
    console.error("Error adding match to sheet", err);
    setState({ saveStatus: "❌ 경기 기록 저장 실패." });
  }
}

// --- LOCAL STORAGE (for formation/quarters) ---
function saveLocalData(){
  const data = { 
    formation: state.formation,
    quarters: state.quarters,
    currentQuarter: state.currentQuarter,
    savedAt: new Date().toISOString()
  };
  localStorage.setItem('hwarangLocalData', JSON.stringify(data));
}
function loadLocalData(){
  const saved = localStorage.getItem('hwarangLocalData');
  const savedData = saved ? safeJSON(saved, null) : null;
  if(savedData){
    setState({
      formation: savedData.formation || state.formation,
      quarters: savedData.quarters || [null,null,null,null],
      currentQuarter: savedData.currentQuarter || 1,
    });
  }
}

// --- PLAYER / ATTEND ---
function toggleAttendance(id){ 
  setState({ players: state.players.map(p=> p.id===id ? {...p, isPresent:!p.isPresent} : p ) }); 
  saveLocalData(); // 출석 상태는 로컬에 저장
}
function clearAllAttendance(){ 
  setState({ players: state.players.map(p=>({...p, isPresent:false})) }); 
  saveLocalData();
}
function setActiveTab(tab){ setState({activeTab:tab}); }
function getPresentPlayers(){ return state.players.filter(p=>p.isPresent); }

// --- MATCH ---
function updateNewMatch(field,v){ setState({ newMatch:{...state.newMatch,[field]:v} }); }
function addMatch(){
  const m = state.newMatch; 
  if(!(m.opponent && m.location && m.date)) {
    toast("⚠️ 상대팀, 경기장, 날짜를 모두 입력해주세요");
    return;
  }
  const matchDate = new Date(m.date);
  const today = new Date(); today.setHours(0, 0, 0, 0);
  if (matchDate < today) { toast("⚠️ 과거 날짜는 선택할 수 없습니다"); return; }
  const goals = Math.max(0, parseInt(m.goals) || 0);
  const conceded = Math.max(0, parseInt(m.conceded) || 0);
  
  if (state.isGapiSignedIn) {
    addMatchToSheet({ ...m, goals, conceded });
  } else {
    toast("⚠️ Google에 로그인해야 저장할 수 있습니다.");
  }
}

function teamStats(){
  const ms = state.matches, matches=ms.length;
  const wins=ms.filter(m=>m.result==="W").length, draws=ms.filter(m=>m.result==="D").length, losses=ms.filter(m=>m.result==="L").length;
  const goalsFor=ms.reduce((s,m)=>s+m.goals,0), goalsAgainst=ms.reduce((s,m)=>s+m.conceded,0), cleanSheets=ms.filter(m=>m.conceded===0).length;
  return { matches,wins,draws,losses,goalsFor,goalsAgainst,cleanSheets,
    winRate: matches?((wins/matches)*100).toFixed(1):0,
    avgGoalsFor: matches?(goalsFor/matches).toFixed(2):0,
    avgGoalsAgainst: matches?(goalsAgainst/matches).toFixed(2):0,
    cleanSheetRate: matches?((cleanSheets/matches)*100).toFixed(1):0
  };
}

// --- QUARTERS ---
function setCurrentQuarter(n){ setState({ currentQuarter:n }); saveLocalData(); }
function saveCurrentFormation(){ /* ... (기존과 동일, 로컬 저장) */ }
function loadQuarter(n){ /* ... (기존과 동일, 로컬 로드) */ }
function clearQuarter(n){ /* ... (기존과 동일, 로컬 삭제) */ }
function clearFormation(){ /* ... (기존과 동일, 로컬 초기화) */ }
function getSavedQuartersCount(){ return state.quarters.filter(q => q !== null).length; }
function quartersPlayedCount(playerId){ /* ... (기존과 동일) */ }

// --- DnD + Tap-to-Assign ---
function fieldCount(f){ return Object.values(f).flat().filter(Boolean).length; }
function handleDragStart(ev, playerId){ /* ... (기존과 동일) */ }
function handleDragEnd(ev){ /* ... (기존과 동일) */ }
function handleDragOver(ev){ /* ... (기존과 동일) */ }
function handleDragLeave(ev){ /* ... (기존과 동일) */ }
function handleDrop(ev, position, slotIndex){ /* ... (기존과 동일) */ }
function removePlayerFromSlot(pos, idx, e){ /* ... (기존과 동일) */ }
function openPicker(position, slotIndex){ /* ... (기존과 동일) */ }
function closePicker(){ /* ... (기존과 동일) */ }
function assignToSlot(playerId){ /* ... (기존과 동일) */ }
function unassignSlot(pos, idx, e){ /* ... (기존과 동일) */ }
let longPressTimer=null;
function onChipTouchStart(pos, idx, e){ longPressTimer = setTimeout(()=>{ removePlayerFromSlot(pos, idx); }, 500); }
function onChipTouchEnd(){ clearTimeout(longPressTimer); }

// --- UI ---
function createApp(){
  return `
  <div class="min-h-screen bg-gray-50">
    ${createNav()}
    <main class="max-w-7xl mx-auto py-4 sm:py-6 px-3 sm:px-4 lg:px-8">
      ${state.activeTab==='dashboard'? createDashboard():''}
      ${state.activeTab==='matches'? createMatches():''}
      ${state.activeTab==='formation'? createFormation():''}
      ${state.activeTab==='members'? createMembers():''}
      ${state.activeTab==='sync'? createSync():''}
    </main>
    ${createBottomSheet()}
  </div>`;
}

function createNav(){
  const tabs = [
    {id:'dashboard', name:'대시보드', icon:'barChart'},
    {id:'matches', name:'경기 기록', icon:'calendar'},
    {id:'formation', name:'포메이션', icon:'target'},
    {id:'members', name:'구성원', icon:'users'},
    {id:'sync', name:'동기화', icon:'sync'},
  ];
  return `
  <nav class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8">
      <div class="flex space-x-2 sm:space-x-6 overflow-x-auto nav-scroll py-2">
        ${tabs.map(t=>`
          <button onclick="setActiveTab('${t.id}')"
            class="py-2 sm:py-3 px-2 border-b-2 font-medium text-xs sm:text-sm whitespace-nowrap flex items-center flex-shrink-0
                   ${state.activeTab===t.id?'border-blue-500 text-blue-600':'border-transparent text-gray-500 hover:text-gray-700'}">
            <span class="icon-lg mr-1">${icons[t.icon]}</span>${t.name}
          </button>`).join('')}
      </div>
    </div>
  </nav>`;
}

function createDashboard(){ /* ... (기존과 동일) */ }
function statCard(label,value,icon,color){ /* ... (기존과 동일) */ }

function createMatches(){
  return `
  <div class="space-y-4 sm:space-y-6">
    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
      <h3 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4">새 경기 추가</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
        <input class="border rounded-lg px-3 py-2 text-sm sm:text-base" placeholder="상대팀" value="${state.newMatch.opponent}" onchange="updateNewMatch('opponent', this.value)">
        <input class="border rounded-lg px-3 py-2 text-sm sm:text-base" placeholder="경기장" value="${state.newMatch.location}" onchange="updateNewMatch('location', this.value)">
        <input type="date" class="border rounded-lg px-3 py-2 text-sm sm:text-base" value="${state.newMatch.date}" onchange="updateNewMatch('date', this.value)">
        <select class="border rounded-lg px-3 py-2 text-sm sm:text-base" value="${state.newMatch.result}" onchange="updateNewMatch('result', this.value)">
          <option value="">결과 선택</option><option value="W">승리</option><option value="D">무승부</option><option value="L">패배</option>
        </select>
        <input type="number" class="border rounded-lg px-3 py-2 text-sm sm:text-base" placeholder="팀 득점" value="${state.newMatch.goals}" onchange="updateNewMatch('goals', parseInt(this.value)||0)">
        <input type="number" class="border rounded-lg px-3 py-2 text-sm sm:text-base" placeholder="팀 실점" value="${state.newMatch.conceded}" onchange="updateNewMatch('conceded', parseInt(this.value)||0)">
        <input class="border rounded-lg px-3 py-2 text-sm sm:text-base lg:col-span-3" placeholder="득점자 (쉼표로 구분)" value="${state.newMatch.scorers}" onchange="updateNewMatch('scorers', this.value)">
      </div>
      <button onclick="addMatch()" class="mt-3 sm:mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center text-sm sm:text-base">${icons.plus}<span class="ml-1">경기 추가</span></button>
    </div>

    <div class="bg-white rounded-lg shadow-md">
      <h3 class="text-base sm:text-lg font-semibold p-4 sm:p-6 border-b">경기 기록</h3>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">날짜</th>
              <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">상대팀</th>
              <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden sm:table-cell">장소</th>
              <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">결과</th>
              <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">스코어</th>
              <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">득점자</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            ${state.matches.map(m=>`
              <tr class="hover:bg-gray-50">
                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900">${m.date}</td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900">${m.opponent}</td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500 hidden sm:table-cell">${m.location}</td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap">
                  <span class="px-2 py-1 text-xs rounded-full ${m.result==='W'?'bg-green-100 text-green-800':m.result==='L'?'bg-red-100 text-red-800':'bg-yellow-100 text-yellow-800'}">${m.result==='W'?'승':m.result==='L'?'패':'무'}</span>
                </td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-medium">${m.score}</td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-600">${m.scorers}</td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>
    </div>
  </div>`;
}

function createFormation(){ /* ... (기존과 동일) */ }
function createPositionRow(position){ /* ... (기존과 동일) */ }
function createQuarterPreview(n){ /* ... (기존과 동일) */ }
function miniRows(q){ /* ... (기존과 동일) */ }
function createBottomSheet(){ /* ... (기존과 동일) */ }

function createMembers(){
  const q = state.playerSearch.trim().toLowerCase();
  const list = q ? state.players.filter(p=>p.name.toLowerCase().includes(q)) : state.players;
  return `
  <div class="space-y-4 sm:space-y-6">
    <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
      <h3 class="text-base sm:text-lg font-semibold mb-2 flex items-center">${icons.users}<span class="ml-2">구성원 관리 안내</span></h3>
      <p class="text-sm text-gray-700">구성원 명단은 Google Sheets의 <span class="font-semibold">'Members'</span> 시트에서 직접 관리합니다. 아래 목록은 시트에서 불러온 내용입니다.</p>
    </div>

    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-2">
        <h3 class="text-base sm:text-lg font-semibold flex items-center">${icons.users}<span class="ml-2">출석 체크</span></h3>
        <div class="flex items-center gap-4">
          <div class="text-sm text-gray-600">📊 출석: <span class="font-semibold text-blue-600">${state.players.filter(p=>p.isPresent).length}명</span></div>
          <button onclick="clearAllAttendance()" class="text-red-500 hover:text-red-700 text-sm font-medium">전체 해제</button>
        </div>
      </div>
      <div class="sm:ml-auto w-full sm:w-64 mb-4">
        <input class="border rounded-lg px-3 py-2 w-full text-sm" placeholder="선수 이름 검색..." value="${state.playerSearch}" oninput="setState({playerSearch:this.value})">
      </div>
      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
        ${list.map(p=>`
          <button onclick="toggleAttendance(${p.id})"
                  class="p-3 rounded-lg border-2 text-left transition-all hover:scale-105 ${p.isPresent?'bg-green-50 border-green-300 text-green-800 shadow-md':'bg-gray-50 border-gray-300 text-gray-600 hover:bg-gray-100'}">
            <div class="flex items-center justify-between mb-1">
              <span class="font-medium text-sm">${p.name}</span>
              <span class="text-xs px-2 py-1 rounded-full ${p.isPresent?'bg-green-100':'bg-gray-100'}">${p.position}</span>
            </div>
            ${p.isPresent?'<div class="text-xs text-green-600 mt-1 font-medium">✅ 출석</div>':''}
          </button>`).join('')}
      </div>
    </div>
  </div>`;
}

function createSync(){
  return `
  <div class="space-y-4 sm:space-y-6">
    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
      <h3 class="text-base sm:text-lg font-semibold mb-4 flex items-center">${icons.sync}<span class="ml-2">Google Sheets 동기화</span></h3>
      
      ${!state.isGapiLoaded ? `
        <div class="text-center py-8">
          <div class="text-gray-500 mb-4">Google API를 로딩 중입니다...</div>
        </div>
      ` : !state.isGapiSignedIn ? `
        <div class="text-center py-8">
          <p class="text-gray-600 mb-4">데이터를 동기화하려면 Google 계정으로 로그인해야 합니다.</p>
          <button onclick="handleAuthClick()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-all">
            Google 로그인
          </button>
        </div>
      ` : `
        <div class="space-y-4">
          <div class="bg-green-50 border border-green-200 p-4 rounded-lg">
            <p class="text-sm text-green-800">✅ Google 계정에 연결되었습니다.</p>
          </div>
          <div class="text-center">
            <button onclick="loadAllDataFromSheets()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-all flex items-center justify-center mx-auto">
              ${icons.sync}<span class="ml-2">지금 동기화하기</span>
            </button>
            <p class="text-xs text-gray-500 mt-2">최신 경기 기록과 구성원 명단을 불러옵니다.</p>
          </div>
          <div class="text-center">
            <button onclick="handleSignoutClick()" class="text-red-500 hover:text-red-700 text-sm font-medium">
              로그아웃
            </button>
          </div>
        </div>
      `}
    </div>
    ${state.saveStatus ? `<div class="bg-white p-4 rounded-lg shadow-md text-center text-sm font-medium ${state.saveStatus.includes('❌') ? 'text-red-600' : 'text-green-600'}">${state.saveStatus}</div>` : ''}
  </div>
`;
}

// --- TOAST ---
let toastTimer=null;
function toast(msg){
  setState({saveStatus:msg});
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>setState({saveStatus:""}), 2000);
}

// --- START ---
document.addEventListener('DOMContentLoaded', ()=>{
  gapi.load('client:auth2', handleClientLoad);
  loadLocalData(); // 로컬 데이터(포메이션 등)는 먼저 로드
});

</script>
<script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()" onreadystatechange="if (this.readyState === 'complete') this.onload()"></script>
</body>
</html>

