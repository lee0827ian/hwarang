<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>화랑FC 관리 시스템</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
  .icon{display:inline-block;width:1rem;height:1rem;vertical-align:middle}
  .icon-lg{width:1.5rem;height:1.5rem}
  /* 경기장 */
  .pitch{position:relative;min-height:520px;background:linear-gradient(#bfe3bf,#9bd49b);border-radius:14px;overflow:hidden;box-shadow:inset 0 0 0 2px rgba(255,255,255,.6)}
  .half{position:absolute;top:50%;left:0;right:0;height:2px;background:#fff;opacity:.9;transform:translateY(-50%)}
  .cc{position:absolute;top:50%;left:50%;width:140px;height:140px;border:2px solid #fff;border-radius:50%;transform:translate(-50%,-50%)}
  .dot{position:absolute;top:50%;left:50%;width:8px;height:8px;background:#fff;border-radius:50%;transform:translate(-50%,-50%)}
  .box{position:absolute;left:50%;width:240px;height:120px;border:2px solid #fff;background:rgba(255,255,255,.06);transform:translateX(-50%)}
  .box.top{top:10px}.box.bot{bottom:10px}
  .slot{width:64px;height:64px;border:2px dashed rgba(255,255,255,.7);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff}
  .ball{width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;box-shadow:0 4px 10px rgba(0,0,0,.15)}
  /* 개선: 드롭 영역 강조 */
  .drop.drag-over{outline:3px solid rgba(59,130,246,.9);outline-offset:6px;background-color:rgba(59,130,246,.1);border-color:transparent}
  /* 개선: 드래그 중인 요소 시각화 */
  .chip{cursor:move;transition:transform 0.15s ease-in-out, box-shadow 0.15s ease-in-out, opacity 0.15s ease-in-out}
  .chip.dragging{opacity:.6;transform:scale(1.05);box-shadow:0 8px 16px rgba(0,0,0,.2)}
  .mini{min-height:180px;background:linear-gradient(#bfe3bf,#9bd49b);border-radius:10px;position:relative;box-shadow:inset 0 0 0 2px rgba(255,255,255,.5)}
  .mini .slot{width:28px;height:28px;border-width:1px;font-size:.55rem}
  .mini .ball{width:28px;height:28px;font-size:.5rem}
</style>
</head>
<body>
<div id="root"></div>

<script>
/* ====== 설정 & 공통 ====== */
const POS = [
  {key:'fw',  label:'FW',  size:2, color:'bg-red-500'},
  {key:'amf', label:'AMF', size:3, color:'bg-orange-500'},
  {key:'cmf', label:'CMF', size:4, color:'bg-blue-500'},
  {key:'dmf', label:'DMF', size:3, color:'bg-teal-500'},
  {key:'def', label:'DEF', size:5, color:'bg-green-500'},
  {key:'gk',  label:'GK',  size:1, color:'bg-purple-500'},
];
const ICONS = {
  plus:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>',
  users:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20v-2a4 4 0 00-4-4H7a4 4 0 00-4 4v2m14 0h3v-2a7 7 0 00-7-7M9 7a4 4 0 118 0 4 4 0 01-8 0z"/></svg>',
  calendar:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 0 00-2 2v12"/></svg>',
  bar:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19V10m-4 9V7m8 12v-4m4 4V4"/></svg>',
  target:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" stroke-width="2"/><circle cx="12" cy="12" r="5" stroke-width="2"/></svg>',
  shield:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 22s8-3 8-10V6l-8-4-8 4v6c0 7 8 10 8 10z"/></svg>',
  save:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>',
  refresh:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.58A8 8 0 1120 12"/></svg>',
  upload:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1M8 12l4-4 4 4M12 8v8"/></svg>'
};
const pitchRows = () => POS.map(p => ({ key:p.key, slots:Array(p.size).fill(null) }));

/* ====== 상태 ====== */
let state = {
  tab: 'dashboard',
  players: [],
  playerSearch: '',
  matches: [],
  formation: toFormation(pitchRows()),
  quarters: [null,null,null,null], // 각 쿼터의 formation 스냅샷
  dragged: null,
  saveMsg: ''
};

function toFormation(rows){ const f={}; rows.forEach(r=>f[r.key]=r.slots.slice()); return f; }
function cloneFormation(f){ const c={}; Object.keys(f).forEach(k=>c[k]=f[k].slice()); return c; }
function setState(p){ state={...state,...p}; render(); }

/* ====== 유틸 ====== */
const sanitize = s => (s||'').toString().trim().replace(/^화랑[\s_\-]?/i,'').replace(/\s{2,}/g,' ').replace(/[^\p{L}\p{N}\s._-]/gu,'').trim();
const findPlayerById = id => state.players.find(p=>p.id===id);
const playerQuarterCount = id => state.quarters.reduce((n,q)=> n + (q && Object.values(q).flat().some(x=>x && x.id===id) ? 1 : 0), 0);

/* ====== 데이터 로딩 (members.json) ====== */
async function loadMembers(){
  try{
    const res = await fetch('members.json?v='+Date.now(), {cache:'no-store'});
    if(!res.ok) return;
    const json = await res.json();
    const arr = Array.isArray(json) ? json : (json && Array.isArray(json.members) ? json.members : []);
    const names = arr.map(sanitize).filter(Boolean);
    const merged = names.map((name,i)=>({
      id: Date.now()+i,
      name, position:'MF', goals:0, assists:0, isPresent:false
    }));
    setState({ players: merged });
  }catch(e){ console.log('members.json 없음 또는 파싱 실패'); }
}

/* ====== 드래그 앤 드롭 (마우스) ====== */
function onDragStart(e,id){ state.dragged = findPlayerById(id); e.currentTarget.classList.add('dragging'); }
function onDragEnd(e){ e.currentTarget.classList.remove('dragging'); state.dragged=null; }
function onDragOver(e){ e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
function onDragLeave(e){ e.currentTarget.classList.remove('drag-over'); }
// 개선: 포메이션 인원수 제한 로직 추가
function onDrop(e,pos,idx){
  e.preventDefault(); e.currentTarget.classList.remove('drag-over');
  const p = state.dragged; if(!p) return;
  const f = cloneFormation(state.formation);
  const existingPlayer = Object.values(f).flat().find(x=>x && x.id===p.id);

  if(existingPlayer) {
    Object.keys(f).forEach(k=> f[k] = f[k].map(x => x && x.id===p.id ? null : x));
  } else {
    const placedCount = Object.values(f).flat().filter(Boolean).length;
    if(placedCount >= 11) {
      flash('포메이션은 최대 11명까지 배치할 수 있어요');
      return;
    }
  }
  
  if(f[pos][idx]) {
    flash('이미 다른 선수가 있는 자리예요');
    return;
  }
  
  f[pos][idx] = p;
  setState({ formation:f });
}

/* ====== 터치 DnD ====== */
let touchCtx = null;
function touchStart(ev,id){
  const t = ev.touches[0]; const el = ev.currentTarget;
  touchCtx = { el, id, dx:0, dy:0 };
  el.classList.add('dragging');
  const r = el.getBoundingClientRect();
  touchCtx.offx = t.clientX - r.left; touchCtx.offy = t.clientY - r.top;
  el.style.position='fixed'; el.style.zIndex='999'; el.style.pointerEvents='none';
  document.addEventListener('touchmove',touchMove,{passive:false});
  document.addEventListener('touchend',touchEnd);
}
function touchMove(ev){
  ev.preventDefault(); if(!touchCtx) return;
  const t = ev.touches[0]; const el = touchCtx.el;
  el.style.left = (t.clientX - touchCtx.offx)+'px';
  el.style.top  = (t.clientY - touchCtx.offy)+'px';
  document.querySelectorAll('.drop').forEach(s=>s.classList.remove('drag-over'));
  const below = document.elementFromPoint(t.clientX,t.clientY);
  const slot = below && below.closest('.drop');
  if(slot) slot.classList.add('drag-over');
}
function touchEnd(ev){
  if(!touchCtx) return;
  const t = ev.changedTouches[0]; const el = touchCtx.el;
  const below = document.elementFromPoint(t.clientX,t.clientY);
  const slot = below && below.closest('.drop');
  if(slot){
    const pos = slot.dataset.pos; const idx = +slot.dataset.idx;
    state.dragged = findPlayerById(touchCtx.id);
    onDrop({preventDefault:()=>{}, currentTarget:slot}, pos, idx);
  }
  el.classList.remove('dragging'); el.style.cssText='';
  document.querySelectorAll('.drop').forEach(s=>s.classList.remove('drag-over'));
  document.removeEventListener('touchmove',touchMove);
  document.removeEventListener('touchend',touchEnd);
  touchCtx=null; state.dragged=null;
}

/* ====== 액션 ====== */
function toggleAttendance(id){
  setState({ players: state.players.map(p => p.id===id ? {...p, isPresent:!p.isPresent} : p) });
}
function clearAttendance(){ setState({ players: state.players.map(p=>({...p,isPresent:false})) }); }
function addPlayer(name,position){
  name = sanitize(name); if(!name) return;
  setState({ players:[...state.players, {id:Date.now(), name, position:position||'FW', goals:0,assists:0,isPresent:false}] });
}
function clearFormation(){ setState({ formation: toFormation(pitchRows()) }); }

function saveQuarter(){
  const placedCount = Object.values(state.formation).flat().filter(Boolean).length;
  if(placedCount < 11) {
    flash('11명이 모두 배치되지 않았어요');
    return;
  }
  const i = state.quarters.findIndex(q => q===null);
  if(i<0){ flash('이미 4쿼터가 모두 채워졌어요'); return; }
  const snap = cloneFormation(state.formation);
  const quarters = state.quarters.slice(); quarters[i] = snap;
  setState({ quarters });
  flash(`쿼터 ${i+1} 저장 완료`);
}
function removeQuarter(i){
  const quarters = state.quarters.slice(); quarters[i]=null;
  setState({ quarters });
}
function flash(msg){ setState({saveMsg:msg}); setTimeout(()=>setState({saveMsg:''}),1400); }

/* ====== 렌더 ====== */
function render(){
  const root = document.getElementById('root');
  root.innerHTML = `
    <div class="min-h-screen bg-gray-50">
      ${nav()}
      <main class="max-w-7xl mx-auto py-4 sm:py-6 px-3 sm:px-4 lg:px-8">
        ${state.tab==='dashboard'? viewDashboard() :
           state.tab==='matches'? viewMatches() :
           state.tab==='formation'? viewFormation() :
           viewPlayers()}
      </main>
    </div>`;
}

/* ====== 뷰들 ====== */
function nav(){
  const tabs = [
    {id:'dashboard', name:'대시보드', icon:'bar'},
    {id:'matches', name:'경기 기록', icon:'calendar'},
    {id:'formation', name:'포메이션', icon:'target'},
    {id:'players', name:'선수 관리', icon:'users'}
  ];
  return `
  <nav class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-8">
      <div class="flex space-x-6 overflow-x-auto">
        ${tabs.map(t=>`
          <button onclick="setState({tab:'${t.id}'})"
            class="py-3 sm:py-4 border-b-2 ${state.tab===t.id?'border-blue-500 text-blue-600':'border-transparent text-gray-500 hover:text-gray-700'}">
            ${ICONS[t.icon]} <span class="ml-1 text-sm">${t.name}</span>
          </button>`).join('')}
      </div>
    </div>
  </nav>`;
}

function viewDashboard(){
  const ms = state.matches, m=ms.length;
  const w=ms.filter(x=>x.result==='W').length, d=ms.filter(x=>x.result==='D').length, l=ms.filter(x=>x.result==='L').length;
  const gf=ms.reduce((s,x)=>s+x.goals,0), ga=ms.reduce((s,x)=>s+x.conceded,0);
  const winRate = m?((w/m)*100).toFixed(1):0;
  const top = [...state.players].sort((a,b)=>b.goals-a.goals).slice(0,5);
  return `
  <div class="space-y-6">
    <div class="bg-gradient-to-r from-green-500 to-blue-600 text-white p-4 sm:p-6 rounded-lg">
      <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3">
        <div>
          <h1 class="text-2xl sm:text-3xl font-bold mb-1">⚽ 화랑 FC</h1>
          <p class="opacity-90">축구는 나의 삶이다</p>
        </div>
        <div class="flex gap-2">
          <button onclick="loadMembers()" class="bg-white/20 hover:bg-white/30 px-3 py-2 rounded-lg text-sm">${ICONS.refresh} 멤버 새로고침</button>
          ${state.saveMsg?`<span class="bg-white/20 px-3 py-2 rounded-lg text-sm">${state.saveMsg}</span>`:''}
        </div>
      </div>
    </div>

    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
      ${statCard("경기수", m, "calendar")}
      ${statCard("승률", winRate+"%", "bar")}
      ${statCard("득점", gf, "target")}
      ${statCard("실점", ga, "shield")}
    </div>

    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
      <h3 class="text-lg font-semibold mb-3">${ICONS.target} Top 득점자</h3>
      ${top.length? top.map((p,i)=>`
        <div class="flex justify-between py-1">
          <div><span class="mr-2 w-6 h-6 inline-flex items-center justify-center rounded-full bg-blue-100 text-blue-600">${i+1}</span>${p.name} <span class="text-xs text-gray-500">(${p.position})</span></div>
          <div class="font-semibold">${p.goals}골</div>
        </div>`).join('') : '<div class="text-gray-500">기록 없음</div>'}
    </div>
  </div>`;
}
function statCard(label,val,icon){
  return `<div class="bg-white p-4 rounded-lg shadow-md">
    <div class="flex items-center justify-between">
      <div><p class="text-gray-600 text-sm">${label}</p><p class="text-2xl font-bold">${val}</p></div>
      <div class="icon-lg">${ICONS[icon]}</div>
    </div></div>`;
}

function viewMatches(){
  return `
  <div class="space-y-6">
    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
      <h3 class="text-lg font-semibold mb-3">새 경기 추가</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
        <input class="border rounded px-3 py-2" placeholder="상대팀" oninput="state._op=this.value">
        <input class="border rounded px-3 py-2" placeholder="경기장" oninput="state._loc=this.value">
        <input type="date" class="border rounded px-3 py-2" oninput="state._dt=this.value">
        <select class="border rounded px-3 py-2" oninput="state._res=this.value">
          <option value="">결과 선택</option><option>W</option><option>D</option><option>L</option>
        </select>
        <input type="number" class="border rounded px-3 py-2" placeholder="득점" oninput="state._gf=+this.value||0">
        <input type="number" class="border rounded px-3 py-2" placeholder="실점" oninput="state._ga=+this.value||0">
      </div>
      <button class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded" onclick="
        (()=>{
          const m = {id:Date.now(), opponent:state._op||'', location:state._loc||'', date:state._dt||'', result:state._res||'', goals:state._gf||0, conceded:state._ga||0, score:(state._gf||0)+'-'+(state._ga||0)};
          if(m.opponent && m.location && m.date){
            setState({matches:[...state.matches,m]});
            state._op=state._loc=state._dt=state._res=''; state._gf=state._ga=0;
          }
        })()
      ">${ICONS.plus} 경기 추가</button>
    </div>

    <div class="bg-white rounded-lg shadow-md overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50"><tr>
          <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase">날짜</th>
          <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase">상대팀</th>
          <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase">장소</th>
          <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase">결과</th>
          <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase">스코어</th>
        </tr></thead>
        <tbody class="divide-y">
          ${state.matches.map(m=>`
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-3 text-sm">${m.date}</td>
              <td class="px-4 py-3 text-sm">${m.opponent}</td>
              <td class="px-4 py-3 text-sm text-gray-500">${m.location}</td>
              <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs ${m.result==='W'?'bg-green-100 text-green-700':m.result==='L'?'bg-red-100 text-red-700':'bg-yellow-100 text-yellow-800'}">${m.result||'-'}</span></td>
              <td class="px-4 py-3 text-sm font-semibold">${m.score}</td>
            </tr>`).join('')}
        </tbody>
      </table>
    </div>
  </div>`;
}

function viewFormation(){
  const present = state.players.filter(p=>p.isPresent);
  const placedCount = Object.values(state.formation).flat().filter(Boolean).length;

  return `
  <div class="space-y-6">
    <div class="bg-white p-4 rounded-lg shadow-md">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <h3 class="text-lg font-semibold">출석 인원</h3>
        <div class="text-sm text-gray-600">출석: ${present.length}명 | 배치: ${placedCount}/11명</div>
      </div>
      <div class="flex flex-wrap gap-2 mt-2">
        ${present.length? present.map(p=>{
          const count = playerQuarterCount(p.id);
          const already = Object.values(state.formation).flat().some(x=>x&&x.id===p.id);
          return `
            <div class="chip ${already?'bg-gray-200 text-gray-500 cursor-not-allowed':'bg-blue-100 text-blue-800 hover:bg-blue-200'} px-3 py-2 rounded-full text-sm select-none"
                 ${already?'':`draggable="true" ondragstart="onDragStart(event, ${p.id})" ondragend="onDragEnd(event)" ontouchstart="touchStart(event, ${p.id})" style="touch-action:none"`}>
              ${p.name} <span class="text-xs opacity-70 ml-1">(${p.position})</span>
              <span class="text-xs ml-2">${count}/4</span>
              ${already?'<span class="ml-1 text-xs">✓</span>':''}
            </div>`;
        }).join('') : '<div class="text-gray-500 text-sm">출석 체크 후 드래그하세요.</div>'}
      </div>
    </div>

    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">포메이션</h3>
        <div class="flex gap-2">
          <button class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded text-sm" onclick="clearFormation()">초기화</button>
          <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm" onclick="saveQuarter()">${ICONS.save} 저장(쿼터)</button>
        </div>
      </div>

      <div class="pitch">
        <div class="half"></div><div class="cc"></div><div class="dot"></div><div class="box top"></div><div class="box bot"></div>
        <div class="relative h-full flex flex-col justify-between py-10">
          ${POS.map(p=>positionRow(p, state.formation[p.key], false)).join('')}
        </div>
      </div>
      ${state.saveMsg?`<div class="text-center mt-3 text-sm text-blue-700">${state.saveMsg}</div>`:''}
    </div>

    <div class="bg-white p-4 rounded-lg shadow-md">
      <h3 class="text-lg font-semibold mb-3">쿼터 스냅샷 (최대 4)</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        ${state.quarters.map((q,i)=>quarterCard(q,i)).join('')}
      </div>
    </div>
  </div>`;
}
function positionRow(pConf, arr, mini){
  const gap = pConf.key==='def'?'gap-1':pConf.key==='dmf'?'gap-6':'gap-4';
  return `
    <div class="flex justify-center ${gap} items-center">
      ${arr.map((pl,idx)=> slot(pConf, idx, pl, mini)).join('')}
    </div>`;
}
function slot(pConf, idx, pl, mini){
  const base = mini?'mini ':''; const color = pConf.color;
  return `
  <div class="drop flex flex-col items-center" data-pos="${pConf.key}" data-idx="${idx}"
       ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event,'${pConf.key}',${idx})">
    ${pl ? `
      <div class="${base}ball ${color} cursor-pointer" title="제거" onclick="
        (()=>{
          const f = {...state.formation}; f['${pConf.key}'] = f['${pConf.key}'].slice(); f['${pConf.key}'][${idx}] = null; setState({formation:f});
        })()
      ">
        <span class="text-center leading-tight px-1">${pl.name}</span>
      </div>
    ` : `<div class="${base}slot text-white/80">빈칸</div>`}
    <div class="text-white/90 text-xs mt-1">${pConf.label}</div>
  </div>`;
}
function quarterCard(q,i){
  if(!q){
    return `<div class="mini p-2 flex items-center justify-center text-gray-600 rounded">
      <div class="text-center">
        <div class="font-semibold mb-1">${i+1}쿼터</div>
        <div class="text-xs">저장된 포메이션 없음</div>
      </div>
    </div>`;
  }
  return `<div class="mini p-2 rounded relative">
    <div class="absolute right-2 top-2">
      <button class="text-xs bg-white/80 hover:bg-white px-2 py-1 rounded" onclick="removeQuarter(${i})">삭제</button>
    </div>
    <div class="text-xs font-semibold mb-1">${i+1}쿼터</div>
    <div class="relative h-full flex flex-col justify-between pb-2">
      ${POS.map(p=>positionRow(p, q[p.key], true)).join('')}
    </div>
  </div>`;
}

function viewPlayers(){
  const q = state.playerSearch.trim().toLowerCase();
  const list = q ? state.players.filter(p=>p.name.toLowerCase().includes(q)) : state.players;
  return `
  <div class="space-y-6">
    <div class="bg-white p-4 rounded-lg shadow-md">
      <div class="flex flex-col sm:flex-row gap-3 sm:items-center">
        <label class="bg-gray-800 text-white px-3 py-2 rounded cursor-pointer text-sm flex items-center">
          ${ICONS.upload} <span class="ml-1">JSON 불러오기</span>
          <input type="file" accept=".json" class="hidden" onchange="importMembers(event)">
        </label>
        <div class="sm:ml-auto flex items-center gap-2">
          <span class="text-sm text-gray-600">검색</span>
          <input class="border rounded px-3 py-2 w-52" placeholder="이름" value="${state.playerSearch}" oninput="setState({playerSearch:this.value})">
        </div>
      </div>
    </div>

    <div class="bg-white p-4 rounded-lg shadow-md">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">출석 체크</h3>
        <div class="flex items-center gap-4 text-sm">
          <span>출석: ${state.players.filter(p=>p.isPresent).length}명</span>
          <button class="text-red-500 hover:text-red-700 text-xs" onclick="clearAttendance()">전체 해제</button>
        </div>
      </div>

      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2">
        ${list.map(p=>`
          <button onclick="toggleAttendance(${p.id})"
            class="p-3 rounded border text-left ${p.isPresent?'bg-green-50 border-green-300 text-green-800':'bg-gray-50 border-gray-300 text-gray-700 hover:bg-gray-100'}">
            <div class="flex justify-between">
              <span class="font-medium">${p.name}</span>
              <span class="text-xs">${p.position}</span>
            </div>
            ${p.isPresent?'<div class="text-xs text-green-600 mt-1">✓ 출석</div>':''}
          </button>`).join('')}
      </div>
    </div>

    <div class="bg-white p-4 rounded-lg shadow-md">
      <h3 class="text-lg font-semibold mb-3">새 선수 추가</h3>
      <div class="flex flex-col sm:flex-row gap-3">
        <input class="border rounded px-3 py-2 flex-1" placeholder="선수 이름" onkeydown="if(event.key==='Enter'){ addPlayer(this.value, state._posAdd||'FW'); this.value=''; }">
        <select class="border rounded px-3 py-2" onchange="state._posAdd=this.value">
          <option value="FW">공격수</option><option value="MF">미드필더</option><option value="DF">수비수</option><option value="GK">골키퍼</option>
        </select>
        <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" onclick="
          (()=>{
            const inp = this.parentElement.querySelector('input'); addPlayer(inp.value, state._posAdd||'FW'); inp.value='';
          })()
        ">${ICONS.plus} 추가</button>
      </div>
    </div>
  </div>`;
}

/* ====== 외부 JSON 임포트 (업로드) ====== */
function importMembers(ev){
  const f = ev.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = () => {
    try{
      const data = JSON.parse(r.result);
      const arr = Array.isArray(data) ? data : (data && Array.isArray(data.members) ? data.members : []);
      const names = arr.map(sanitize).filter(Boolean);
      const merged = names.map((name,i)=>({ id: Date.now()+i, name, position:'MF', goals:0, assists:0, isPresent:false }));
      setState({ players: merged });
    }catch(e){ alert('JSON 파싱 실패: '+e.message); }
    ev.target.value='';
  };
  r.readAsText(f);
}

/* ====== 시작 ====== */
document.addEventListener('DOMContentLoaded', async ()=>{
  await loadMembers(); // members.json 있어도 없어서도 OK
  render();
});
</script>
</body>
</html>
