<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>화랑FC 관리 시스템</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin:0; padding:0; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; }
    .icon { display:inline-block; width:1rem; height:1rem; vertical-align:middle; }
    .icon-lg { width:1.5rem; height:1.5rem; }
    @media (min-width:640px){ .icon-lg{ width:2rem; height:2rem; } }

    /* Pitch */
    .pitch{ position:relative; min-height:420px; background:linear-gradient(#bfe3bf,#9bd49b); border-radius:14px; overflow:hidden; box-shadow:inset 0 0 0 2px rgba(255,255,255,.6) }
    @media (min-width:640px){ .pitch{ min-height:640px; } }
    .pitch .half-line{ position:absolute; top:50%; left:0; right:0; height:2px; background:rgba(255,255,255,.9); transform:translateY(-50%) }
    .pitch .center-circle{ position:absolute; top:50%; left:50%; width:120px; height:120px; border:2px solid rgba(255,255,255,.9); border-radius:50%; transform:translate(-50%,-50%) }
    @media (min-width:640px){ .pitch .center-circle{ width:160px; height:160px } }
    .pitch .center-dot{ position:absolute; top:50%; left:50%; width:8px; height:8px; background:#fff; border-radius:50%; transform:translate(-50%,-50%) }
    .pitch .box{ position:absolute; left:50%; width:220px; height:100px; border:2px solid rgba(255,255,255,.9); transform:translateX(-50%); background:rgba(255,255,255,.06) }
    @media (min-width:640px){ .pitch .box{ width:260px; height:140px } }
    .pitch .box.top{ top:10px } .pitch .box.bottom{ bottom:10px }

    /* DnD */
    .player-chip.dragging{ opacity:.55 }
    .drop-slot.drag-over{ outline:2px dashed rgba(59,130,246,.9); outline-offset:4px }

    /* Mobile nav scroll */
    .nav-scroll{ scrollbar-width:none; -ms-overflow-style:none }
    .nav-scroll::-webkit-scrollbar{ display:none }

    /* 균형 그리드 (슬롯 수만큼 동일 분할) */
    .row-grid { display:grid; align-items:center; }
    .row-grid.cols-1{ grid-template-columns: repeat(1, 1fr); }
    .row-grid.cols-2{ grid-template-columns: repeat(2, 1fr); }
    .row-grid.cols-3{ grid-template-columns: repeat(3, 1fr); }
    .row-grid.cols-4{ grid-template-columns: repeat(4, 1fr); }
    .row-grid.cols-5{ grid-template-columns: repeat(5, 1fr); }
    .row-grid .cell{ display:flex; flex-direction:column; align-items:center; gap:4px; }

    /* 미니 프리뷰 피치 */
    .mini-pitch{ position:relative; height:120px; background:linear-gradient(#bfe3bf,#9bd49b); border-radius:10px; overflow:hidden; box-shadow:inset 0 0 0 2px rgba(255,255,255,.5) }
    .mini-pitch .half-line{ position:absolute; top:50%; left:0; right:0; height:2px; background:rgba(255,255,255,.7); transform:translateY(-50%) }
    .mini-pitch .box{ position:absolute; left:50%; width:120px; height:52px; border:2px solid rgba(255,255,255,.7); transform:translateX(-50%); background:rgba(255,255,255,.06) }
    .mini-pitch .box.top{ top:6px } .mini-pitch .box.bottom{ bottom:6px }
    .mini-row{ position:absolute; left:8px; right:8px; display:grid; place-items:center; }
    .mini-badge{ font-size:10px; line-height:1; color:#fff; background:rgba(59,130,246,.9); padding:3px 6px; border-radius:999px; white-space:nowrap; max-width:90px; overflow:hidden; text-overflow:ellipsis; }

    /* 길게 누르기 힌트 감안한 선택 방지 */
    .no-select{ user-select:none; -webkit-user-select:none; }
  </style>
</head>
<body>
<div id="root"></div>

<script>
/* ================== STATE ================== */
let state = {
  activeTab: "dashboard",
  players: [],
  matches: [],
  formation: {
    gk: [null],                 // 1
    def: [null,null,null,null], // 4
    dmf: [null,null],           // 2
    cmf: [null,null,null],      // 3
    amf: [null,null],           // 2
    fw:  [null]                 // 1  (총 13칸 중 실제는 11명 제한)
  },
  // 쿼터 저장소 (1~4). 각 항목은 formation deep copy
  quarters: [null, null, null, null],
  currentQuarter: 1,

  newMatch: { opponent:"", location:"", date:"", result:"", goals:0, conceded:0 },
  newPlayer: { name:"", position:"FW" },
  draggedPlayer: null,
  saveStatus: "",
  playerSearch: "",
  ui: { pickerOpen:false, pickerPos:null, pickerSlot:null, pickerSearch:"" },
  swapBuffer: null
};
const positionLabels = {
  gk: ['GK'],
  def: ['LB','CB','CB','RB'],
  dmf: ['DMF','DMF'],
  cmf: ['LM','CM','RM'],
  amf: ['LW','RW'],
  fw:  ['ST']
};
const rowOrder = ['fw','amf','cmf','dmf','def','gk']; // 위에서 아래로
const icons = {
  plus:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>',
  users:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20v-2a4 4 0 00-4-4H7a4 4 0 00-4 4v2m14 0h3v-2a7 7 0 00-7-7M9 7a4 4 0 118 0 4 4 0 01-8 0z"/></svg>',
  calendar:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12"/></svg>',
  barChart:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19V10m-4 9V7m8 12v-4m4 4V4"/></svg>',
  target:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" stroke-width="2"/><circle cx="12" cy="12" r="5" stroke-width="2"/></svg>',
  shield:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 22s8-3 8-10V6l-8-4-8 4v6c0 7 8 10 8 10z"/></svg>',
  save:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 01-2 2H6a2 2 0 01-2-2V7a2 2 0 012-2h3"/></svg>',
  upload:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1M8 12l4-4 4 4M12 8v8"/></svg>',
  download:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1M8 12l4 4 4-4M12 16V4"/></svg>',
  trash:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5-4h4a2 2 0 012 2v2H8V5a2 2 0 012-2z"/></svg>'
};

/* ================== RENDER/STATE ================== */
function render(){ document.getElementById('root').innerHTML = createApp(); }
function setState(p){ state = {...state, ...p}; render(); autosave(); }

/* ================== UTILS ================== */
function sanitizeName(raw){
  if(!raw) return "";
  let s = String(raw).trim();
  s = s.replace(/^화랑[\s_\-]?/i, "");
  s = s.replace(/\s{2,}/g, " ");
  s = s.replace(/[^\p{L}\p{N}\s._-]/gu, "");
  return s.trim();
}
function safeJSON(s, fallback){ try{ return JSON.parse(s); }catch{ return fallback; } }
function deepCopyFormation(f){ return JSON.parse(JSON.stringify(f)); }

/* ================== STORAGE / LOAD ================== */
async function loadData(){
  const saved = localStorage.getItem('soccerTeamData');
  const savedData = saved ? safeJSON(saved, null) : null;
  if(savedData){
    setState({
      players: savedData.players || [],
      matches: savedData.matches || [],
      formation: savedData.formation || state.formation,
      quarters: savedData.quarters || [null,null,null,null],
      currentQuarter: savedData.currentQuarter || 1,
      saveStatus:"✓ 저장된 데이터 불러옴"
    });
    setTimeout(()=>setState({saveStatus:""}),1200);
  }

  // members.json 병합
  try{
    const res = await fetch('members.json?v='+Date.now(), { cache:'no-store' });
    if(res.ok){
      const json = await res.json();
      const names = Array.isArray(json) ? json : (json && Array.isArray(json.members)) ? json.members : [];
      const cleaned = names.map(sanitizeName).filter(Boolean);

      const byName = new Map(state.players.map(p=>[p.name,p]));
      const merged = [];
      cleaned.forEach(n=>{
        if(byName.has(n)){ merged.push(byName.get(n)); byName.delete(n); }
        else merged.push({ id: Date.now()+Math.random(), name:n, position:"MF", goals:0, assists:0, attendance:0, isPresent:false });
      });
      byName.forEach(v=>merged.push(v));
      setState({ players: merged, saveStatus:"✓ members.json 연동됨" });
      setTimeout(()=>setState({saveStatus:""}),1000);
    }
  }catch{}

  render();
}
function autosave(){
  const data = { 
    players: state.players, matches: state.matches, formation: state.formation,
    quarters: state.quarters, currentQuarter: state.currentQuarter,
    savedAt: new Date().toISOString()
  };
  localStorage.setItem('soccerTeamData', JSON.stringify(data));
}
function saveData(){ autosave(); setState({saveStatus:"✓ 저장 완료"}); setTimeout(()=>setState({saveStatus:""}),1200); }
function downloadBackup(){
  const data = { players: state.players, matches: state.matches, formation: state.formation, quarters: state.quarters, currentQuarter: state.currentQuarter, exportedAt: new Date().toISOString(), version:"1.1" };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `hwarang-backup-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  setState({saveStatus:"✓ 백업 다운로드됨"}); setTimeout(()=>setState({saveStatus:""}),1200);
}

/* ================== IMPORT FILE (선택형) ================== */
function importMembersFile(ev){
  const file = ev.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = (e)=>{
    try{
      const json = JSON.parse(e.target.result);
      const arr = Array.isArray(json) ? json : Array.isArray(json.members) ? json.members : null;
      if(!arr){ alert("형식: 배열 또는 {members:[...]}"); return; }
      const cleaned = arr.map(sanitizeName).filter(n=>n);
      const byName = new Map(state.players.map(p=>[p.name,p]));
      const merged = [];
      cleaned.forEach(n=>{
        if(byName.has(n)){ merged.push(byName.get(n)); byName.delete(n); }
        else merged.push({ id: Date.now()+Math.random(), name:n, position:"MF", goals:0, assists:0, attendance:0, isPresent:false });
      });
      byName.forEach(v=>merged.push(v));
      setState({ players: merged, saveStatus:"✓ JSON 반영됨" });
      setTimeout(()=>setState({saveStatus:""}),1200);
    }catch(err){ alert("JSON 파싱 실패: "+err.message); }
    finally{ ev.target.value=""; }
  };
  reader.readAsText(file);
}

/* ================== PLAYER / ATTEND ================== */
function addPlayer(){
  const name = sanitizeName(state.newPlayer.name); if(!name) return;
  setState({
    players: [...state.players, { id:Date.now(), name, position: state.newPlayer.position||"FW", goals:0, assists:0, attendance:0, isPresent:false }],
    newPlayer: { name:"", position:"FW" }
  });
}
function toggleAttendance(id){ setState({ players: state.players.map(p=> p.id===id ? {...p, isPresent:!p.isPresent} : p ) }); }
function clearAllAttendance(){ setState({ players: state.players.map(p=>({...p, isPresent:false})) }); }
function setActiveTab(tab){ setState({activeTab:tab}); }
function updateNewPlayer(field, v){ setState({ newPlayer: {...state.newPlayer, [field]:v} }); }
function getPresentPlayers(){ return state.players.filter(p=>p.isPresent); }

/* ================== MATCH ================== */
function updateNewMatch(field,v){ setState({ newMatch:{...state.newMatch,[field]:v} }); }
function addMatch(){
  const m = state.newMatch; if(!(m.opponent && m.location && m.date)) return;
  const score = `${m.goals}-${m.conceded}`;
  const newM = { ...m, id:Date.now(), score, goals:parseInt(m.goals)||0, conceded:parseInt(m.conceded)||0 };
  setState({ matches:[...state.matches,newM], newMatch:{opponent:"",location:"",date:"",result:"",goals:0,conceded:0} });
}
function teamStats(){
  const ms = state.matches, matches=ms.length;
  const wins=ms.filter(m=>m.result==="W").length, draws=ms.filter(m=>m.result==="D").length, losses=ms.filter(m=>m.result==="L").length;
  const goalsFor=ms.reduce((s,m)=>s+m.goals,0), goalsAgainst=ms.reduce((s,m)=>s+m.conceded,0), cleanSheets=ms.filter(m=>m.conceded===0).length;
  return { matches,wins,draws,losses,goalsFor,goalsAgainst,cleanSheets,
    winRate: matches?((wins/matches)*100).toFixed(1):0,
    avgGoalsFor: matches?(goalsFor/matches).toFixed(2):0,
    avgGoalsAgainst: matches?(goalsAgainst/matches).toFixed(2):0,
    cleanSheetRate: matches?((cleanSheets/matches)*100).toFixed(1):0
  };
}

/* ================== QUARTERS (1~4) ================== */
function setCurrentQuarter(n){ setState({ currentQuarter:n }); }
function saveCurrentQuarter(){
  const copy = deepCopyFormation(state.formation);
  const idx = state.currentQuarter - 1;
  const quarters = state.quarters.slice(); quarters[idx] = copy;
  setState({ quarters, saveStatus:`✓ ${state.currentQuarter}쿼터 저장` });
  setTimeout(()=>setState({saveStatus:""}),1000);
}
function loadQuarter(n){
  const q = state.quarters[n-1]; if(!q) return;
  setState({ formation: deepCopyFormation(q), currentQuarter:n, saveStatus:`✓ ${n}쿼터 불러옴` });
  setTimeout(()=>setState({saveStatus:""}),800);
}
function clearQuarter(n){
  const quarters = state.quarters.slice(); quarters[n-1] = null;
  setState({ quarters, saveStatus:`✓ ${n}쿼터 삭제` });
  setTimeout(()=>setState({saveStatus:""}),800);
}
function quartersPlayedCount(playerId){
  return state.quarters.reduce((acc,q)=>{
    if(!q) return acc;
    const found = Object.values(q).flat().some(p=>p && p.id===playerId);
    return acc + (found?1:0);
  },0);
}

/* ================== DnD + Tap-to-Assign ================== */
function fieldCount(f){ return Object.values(f).flat().filter(Boolean).length; }

// DnD
function handleDragStart(ev, playerId){
  const player = state.players.find(p=>p.id===playerId);
  state.draggedPlayer = player;
  ev.dataTransfer.effectAllowed = "move";
  ev.currentTarget.classList.add("dragging");
}
function handleDragEnd(ev){ ev.currentTarget.classList.remove("dragging"); state.draggedPlayer=null; }
function handleDragOver(ev){ ev.preventDefault(); ev.dataTransfer.dropEffect="move"; ev.currentTarget.classList.add("drag-over"); }
function handleDragLeave(ev){ ev.currentTarget.classList.remove("drag-over"); }
function handleDrop(ev, position, slotIndex){
  ev.preventDefault(); ev.currentTarget.classList.remove("drag-over");
  const dragged = state.draggedPlayer; if(!dragged) return;

  const count = fieldCount(state.formation);
  const already = Object.values(state.formation).flat().some(p=>p && p.id===dragged.id);
  if(!already && count>=11){ toast("⚠️ 필드 11명 제한"); return; }
  if(state.formation[position][slotIndex] !== null) return;

  const formation = {...state.formation};
  Object.keys(formation).forEach(k=>{ formation[k] = formation[k].map(x => x && x.id===dragged.id ? null : x); });
  formation[position] = [...formation[position]];
  formation[position][slotIndex] = dragged;
  setState({ formation });
  state.draggedPlayer=null;
}

// Tap bottom sheet
function openPicker(position, slotIndex){
  setState({ ui:{ pickerOpen:true, pickerPos:position, pickerSlot:slotIndex, pickerSearch:"" } });
}
function closePicker(){ setState({ ui:{...state.ui, pickerOpen:false, pickerPos:null, pickerSlot:null, pickerSearch:""}, swapBuffer:null }); }
function assignToSlot(playerId){
  const {pickerPos:pos, pickerSlot:idx} = state.ui; if(pos==null) return;
  const formation = {...state.formation};
  const count = fieldCount(formation);
  const already = Object.values(formation).flat().some(p=>p && p.id===playerId);
  if(!already && count>=11){ toast("⚠️ 필드 11명 제한"); return; }

  const player = state.players.find(p=>p.id===playerId);
  Object.keys(formation).forEach(k=>{ formation[k] = formation[k].map(x => x && x.id===playerId ? null : x); });
  formation[pos] = [...formation[pos]]; formation[pos][idx] = player;
  setState({ formation }); closePicker();
}
function unassignSlot(pos, idx, e){
  if(e){ e.stopPropagation(); e.preventDefault(); }
  const formation = {...state.formation}; formation[pos] = [...formation[pos]]; formation[pos][idx]=null; setState({ formation });
}
function startSwap(pos, idx){ if(state.swapBuffer){ setState({swapBuffer:null}); return; } setState({ swapBuffer:{position:pos, slotIndex:idx} }); }
function finishSwap(targetPlayerId){
  const buf = state.swapBuffer; if(!buf) return;
  const formation = {...state.formation};
  // 대상 선수 현재 위치
  let tp=null, ts=null;
  Object.entries(formation).forEach(([k,slots])=>{ slots.forEach((p,i)=>{ if(p && p.id===targetPlayerId){ tp=k; ts=i; } }); });
  const a = formation[buf.position][buf.slotIndex];
  if(!a){ // 빈칸 → 단순 배치
    const player = state.players.find(p=>p.id===targetPlayerId);
    if(tp!=null) formation[tp][ts]=null;
    formation[buf.position][buf.slotIndex]=player;
  }else{
    if(tp!=null) formation[tp][ts]=a;
    formation[buf.position][buf.slotIndex]= state.players.find(p=>p.id===targetPlayerId);
  }
  setState({ formation, swapBuffer:null }); closePicker();
}

/* 길게 누르면 제거 (모바일) */
let longPressTimer=null;
function onChipTouchStart(pos, idx, e){
  longPressTimer = setTimeout(()=>{ unassignSlot(pos, idx); }, 500);
}
function onChipTouchEnd(){ clearTimeout(longPressTimer); }

/* ================== UI ================== */
function createApp(){
  return `
  <div class="min-h-screen bg-gray-50">
    ${createNav()}
    <main class="max-w-7xl mx-auto py-4 sm:py-6 px-3 sm:px-4 lg:px-8">
      ${state.activeTab==='dashboard'? createDashboard():''}
      ${state.activeTab==='matches'? createMatches():''}
      ${state.activeTab==='formation'? createFormation():''}
      ${state.activeTab==='players'? createPlayers():''}
    </main>
    ${createBottomSheet()}
  </div>`;
}
function createNav(){
  const tabs = [
    {id:'dashboard', name:'대시보드', icon:'barChart'},
    {id:'matches', name:'경기 기록', icon:'calendar'},
    {id:'formation', name:'포메이션', icon:'target'},
    {id:'players', name:'선수 관리', icon:'users'}
  ];
  return `
  <nav class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8">
      <div class="flex space-x-2 sm:space-x-6 overflow-x-auto nav-scroll py-2">
        ${tabs.map(t=>`
          <button onclick="setActiveTab('${t.id}')"
            class="py-2 sm:py-3 px-2 border-b-2 font-medium text-xs sm:text-sm whitespace-nowrap flex items-center flex-shrink-0
                   ${state.activeTab===t.id?'border-blue-500 text-blue-600':'border-transparent text-gray-500 hover:text-gray-700'}">
            <span class="icon-lg mr-1">${icons[t.icon]}</span>${t.name}
          </button>`).join('')}
      </div>
    </div>
  </nav>`;
}
function createDashboard(){
  const s = teamStats();
  const top = [...state.players].sort((a,b)=>b.goals-a.goals).slice(0,5);
  return `
  <div class="space-y-4 sm:space-y-6">
    <div class="bg-gradient-to-r from-green-500 to-blue-600 text-white p-4 sm:p-6 rounded-lg">
      <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 sm:gap-4">
        <div>
          <h1 class="text-2xl sm:text-3xl font-bold mb-1 sm:mb-2">⚽ 화랑 FC</h1>
          <p class="text-sm sm:text-lg opacity-90">축구는 나의 삶이다</p>
        </div>
        <div class="flex flex-col sm:flex-row gap-2">
          <button onclick="saveData()" class="bg-white/20 hover:bg-white/30 px-3 py-2 rounded-lg flex items-center justify-center text-sm">${icons.save}<span class="ml-1">저장</span></button>
          <button onclick="downloadBackup()" class="bg-white/20 hover:bg-white/30 px-3 py-2 rounded-lg flex items-center justify-center text-sm">${icons.download}<span class="ml-1">백업</span></button>
        </div>
      </div>
      ${state.saveStatus?`<div class="mt-3 text-sm opacity-90 bg-white/10 px-3 py-2 rounded-lg">${state.saveStatus}</div>`:''}
    </div>

    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
      ${statCard("경기수", s.matches, "calendar","text-green-500")}
      ${statCard("승률", s.winRate+"%", "barChart","text-blue-500")}
      ${statCard("득점", s.goalsFor, "target","text-red-500")}
      ${statCard("실점", s.goalsAgainst, "shield","text-purple-500")}
    </div>

    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
      <h3 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4 flex items-center">${icons.target}<span class="ml-1">Top 득점자</span></h3>
      ${top.length ? top.map((p,i)=>`
        <div class="flex items-center justify-between py-1">
          <div class="flex items-center">
            <span class="w-5 h-5 sm:w-6 sm:h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs sm:text-sm font-semibold mr-2 sm:mr-3">${i+1}</span>
            <span class="text-sm sm:text-base">${p.name}</span>
            <span class="ml-1 sm:ml-2 text-xs text-gray-500">(${p.position})</span>
          </div>
          <span class="text-sm sm:text-base font-semibold">${p.goals}골</span>
        </div>`).join('') : '<div class="text-gray-500 text-sm text-center py-4">득점 기록이 없습니다</div>'}
    </div>
  </div>`;
}
function statCard(label,value,icon,color){
  return `
  <div class="bg-white p-3 sm:p-4 rounded-lg shadow-md border-l-4 border-gray-100">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-gray-600 text-xs sm:text-sm">${label}</p>
        <p class="text-lg sm:text-2xl font-bold text-gray-800">${value}</p>
      </div>
      <div class="icon-lg ${color} flex-shrink-0">${icons[icon]}</div>
    </div>
  </div>`;
}
function createMatches(){
  return `
  <div class="space-y-4 sm:space-y-6">
    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
      <h3 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4">새 경기 추가</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
        <input class="border rounded-lg px-3 py-2 text-sm sm:text-base" placeholder="상대팀" value="${state.newMatch.opponent}" onchange="updateNewMatch('opponent', this.value)">
        <input class="border rounded-lg px-3 py-2 text-sm sm:text-base" placeholder="경기장" value="${state.newMatch.location}" onchange="updateNewMatch('location', this.value)">
        <input type="date" class="border rounded-lg px-3 py-2 text-sm sm:text-base" value="${state.newMatch.date}" onchange="updateNewMatch('date', this.value)">
        <select class="border rounded-lg px-3 py-2 text-sm sm:text-base" value="${state.newMatch.result}" onchange="updateNewMatch('result', this.value)">
          <option value="">결과 선택</option><option value="W">승리</option><option value="D">무승부</option><option value="L">패배</option>
        </select>
        <input type="number" class="border rounded-lg px-3 py-2 text-sm sm:text-base" placeholder="득점" value="${state.newMatch.goals}" onchange="updateNewMatch('goals', parseInt(this.value)||0)">
        <input type="number" class="border rounded-lg px-3 py-2 text-sm sm:text-base" placeholder="실점" value="${state.newMatch.conceded}" onchange="updateNewMatch('conceded', parseInt(this.value)||0)">
      </div>
      <button onclick="addMatch()" class="mt-3 sm:mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center text-sm sm:text-base">${icons.plus}<span class="ml-1">경기 추가</span></button>
    </div>

    <div class="bg-white rounded-lg shadow-md">
      <h3 class="text-base sm:text-lg font-semibold p-4 sm:p-6 border-b">경기 기록</h3>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">날짜</th>
              <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">상대팀</th>
              <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden sm:table-cell">장소</th>
              <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">결과</th>
              <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">스코어</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            ${state.matches.map(m=>`
              <tr class="hover:bg-gray-50">
                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900">${m.date}</td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900">${m.opponent}</td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500 hidden sm:table-cell">${m.location}</td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap">
                  <span class="px-2 py-1 text-xs rounded-full ${m.result==='W'?'bg-green-100 text-green-800':m.result==='L'?'bg-red-100 text-red-800':'bg-yellow-100 text-yellow-800'}">${m.result==='W'?'승':m.result==='L'?'패':'무'}</span>
                </td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-medium">${m.score}</td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>
    </div>
  </div>`;
}

/* ===== Formation ===== */
function createFormation(){
  const present = getPresentPlayers();
  const total = Object.values(state.formation).flat().filter(Boolean).length;

  return `
  <div class="space-y-4 sm:space-y-6">
    <!-- 상단: 쿼터 컨트롤 -->
    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-600">현재 쿼터</span>
          ${[1,2,3,4].map(n=>`
            <button onclick="setCurrentQuarter(${n})"
              class="px-3 py-1 rounded text-sm ${state.currentQuarter===n?'bg-blue-600 text-white':'bg-gray-100 hover:bg-gray-200'}">${n}</button>`).join('')}
        </div>
        <div class="flex items-center gap-2">
          <button onclick="saveCurrentQuarter()" class="bg-blue-600 text-white px-3 py-2 rounded text-sm flex items-center">${icons.save}<span class="ml-1">현재 쿼터 저장</span></button>
        </div>
      </div>
      <div class="mt-2 text-xs text-gray-600">출석: ${present.length}명 | 배치: ${total}/11명</div>
    </div>

    <!-- 출석 명단(드래그 원천) -->
    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
      <h3 class="text-base sm:text-lg font-semibold mb-3">출석 인원</h3>
      <div class="flex flex-wrap gap-2">
        ${present.map(p=>{
          const placed = Object.values(state.formation).flat().some(x=>x && x.id===p.id);
          const played = quartersPlayedCount(p.id);
          return `
          <div class="player-chip no-select ${placed?'bg-gray-200 text-gray-500':'bg-blue-100 text-blue-800'} px-2 sm:px-3 py-1 sm:py-2 rounded-full text-xs sm:text-sm font-medium ${placed?'cursor-not-allowed':'cursor-move hover:bg-blue-200'}"
               ${!placed?'draggable="true" ondragstart="handleDragStart(event, '+p.id+')" ondragend="handleDragEnd(event)"':''}
               style="touch-action:none;">
            <span class="mr-1">${p.name}</span>
            <span class="text-[11px] opacity-75">(${p.position})</span>
            <span class="ml-1 text-[10px] opacity-75">(${played}/4)</span>
            ${placed?'<span class="ml-1 text-[10px]">✓</span>':''}
          </div>`;
        }).join('')}
      </div>
      ${present.length===0?'<p class="text-gray-500 text-xs sm:text-sm mt-2">선수 관리 탭에서 출석 체크 후 배치하세요.</p>':''}
    </div>

    <!-- 포메이션 -->
    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
      <h3 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4">포메이션</h3>
      <div class="pitch">
        <div class="half-line"></div><div class="center-circle"></div><div class="center-dot"></div>
        <div class="box top"></div><div class="box bottom"></div>

        <div class="relative h-full flex flex-col justify-between py-8 sm:py-16">
          ${rowOrder.map(pos => createPositionRow(pos)).join('')}
        </div>
      </div>

      <div class="mt-3 sm:mt-4 text-center">
        <span class="text-xs sm:text-sm font-medium ${total===11?'text-green-600': total>11?'text-red-600':'text-gray-700'}">
          필드 선수: ${total}/11명 ${total>11?' (인원 초과!)':''} ${total===11?' ✓ 완료':''}
        </span>
      </div>

      <div class="mt-3 sm:mt-4 text-center">
        <button onclick="clearFormation()" class="bg-gray-600 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-gray-700 text-xs sm:text-sm">포메이션 초기화</button>
      </div>
    </div>

    <!-- 쿼터 미리보기 (세로로 1,2,3,4) -->
    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
      <h3 class="text-base sm:text-lg font-semibold mb-3">쿼터 미리보기</h3>
      <div class="space-y-4">
        ${[1,2,3,4].map(n => createQuarterPreview(n)).join('')}
      </div>
    </div>
  </div>`;
}
function createPositionRow(position){
  const slots = state.formation[position];
  const labels = positionLabels[position] || [];
  const color = position==='gk'?'bg-purple-500'
              : position==='def'?'bg-green-500'
              : position==='dmf'?'bg-teal-500'
              : position==='cmf'?'bg-blue-500'
              : position==='amf'?'bg-orange-500'
              : 'bg-red-500';

  return `
  <div class="row-grid cols-${slots.length} gap-2 sm:gap-4 px-4">
    ${slots.map((player,idx)=>`
      <div class="cell drop-slot"
           data-position="${position}" data-slot-index="${idx}"
           ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)"
           ondrop="handleDrop(event, '${position}', ${idx})"
           onclick="openPicker('${position}', ${idx})">

        ${player?`
          <div class="relative">
            <div class="w-12 h-12 sm:w-16 sm:h-16 ${color} rounded-full flex items-center justify-center text-white text-[11px] sm:text-xs font-bold shadow-md cursor-pointer no-select"
                 title="탭하면 교체/제거"
                 ontouchstart="onChipTouchStart('${position}', ${idx}, event)" ontouchend="onChipTouchEnd()">
              <span class="text-center leading-tight px-1">${player.name}</span>
            </div>
            <button class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-white text-xs flex items-center justify-center"
                    onclick="unassignSlot('${position}', ${idx}, event)">×</button>
          </div>
        ` : `
          <div class="w-12 h-12 sm:w-16 sm:h-16 border-2 border-dashed border-white/60 rounded-full flex items-center justify-center text-white/80 text-[11px] sm:text-xs">
            <span class="text-center">빈칸</span>
          </div>`}

        <div class="text-white/90 text-[10px] sm:text-xs font-medium">${labels[idx]||''}</div>
      </div>
    `).join('')}
  </div>`;
}

/* 쿼터 프리뷰 카드 (세로로 1,2,3,4) */
function createQuarterPreview(n){
  const q = state.quarters[n-1];
  const title = `${n}쿼터`;
  return `
  <div class="border rounded-lg p-3">
    <div class="flex items-center justify-between mb-2">
      <div class="font-medium text-sm">${title} ${q?'':'(비어있음)'}</div>
      <div class="flex items-center gap-2">
        <button class="text-xs px-2 py-1 rounded ${q?'bg-blue-600 text-white':'bg-gray-100 text-gray-500 cursor-not-allowed'}"
                ${q?`onclick="loadQuarter(${n})"`:'disabled'}>불러오기</button>
        <button class="text-xs px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 flex items-center"
                onclick="clearQuarter(${n})">${icons.trash}<span class="ml-1">삭제</span></button>
      </div>
    </div>
    <div class="mini-pitch relative">
      <div class="half-line"></div><div class="box top"></div><div class="box bottom"></div>
      ${miniRows(q)}
    </div>
  </div>`;
}
function miniRows(q){
  // y 위치: 위에서부터 fw, amf, cmf, dmf, def, gk 순으로 고정
  const positions = rowOrder;
  const yPerc = [10, 28, 46, 64, 82, 94]; // 대략적 줄 위치(%)
  return positions.map((pos,i)=>{
    const arr = q ? q[pos] : new Array((state.formation[pos]||[]).length).fill(null);
    const cols = arr.length||1;
    const left = 8, right = 8; // 좌우 여백
    const rowStyle = `top:${yPerc[i]}%; left:${left}px; right:${right}px; grid-template-columns: repeat(${cols},1fr)`;
    return `
      <div class="mini-row" style="${rowStyle}">
        ${arr.map(p=> `<div class="mini-badge">${p?p.name:'-'}</div>`).join('')}
      </div>`;
  }).join('');
}

/* ================== BOTTOM SHEET ================== */
function createBottomSheet(){
  if(!state.ui.pickerOpen) return '';
  const pos = state.ui.pickerPos, idx = state.ui.pickerSlot;
  const inSlot = state.formation[pos][idx];
  const assignedIds = new Set(Object.values(state.formation).flat().filter(Boolean).map(p=>p.id));
  const q = state.ui.pickerSearch.trim().toLowerCase();
  const candidates = state.players
    .filter(p=>p.isPresent)
    .filter(p=> !assignedIds.has(p.id) || (inSlot && p.id===inSlot.id))
    .filter(p=> p.name.toLowerCase().includes(q));

  return `
  <div class="fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/30" onclick="closePicker()"></div>
    <div class="absolute left-0 right-0 bottom-0 bg-white rounded-t-2xl shadow-2xl p-4 pt-3">
      <div class="flex items-center justify-between mb-2">
        <div class="text-sm text-gray-600">슬롯: <b>${pos.toUpperCase()} ${idx+1}</b></div>
        <button class="text-gray-500 text-sm" onclick="closePicker()">닫기</button>
      </div>
      <div class="flex items-center gap-2 mb-3">
        <input class="border rounded-lg px-3 py-2 w-full text-sm" placeholder="이름 검색" value="${state.ui.pickerSearch}"
               oninput="setState({ ui:{...state.ui, pickerSearch:this.value} })">
        ${inSlot?`<button class="px-3 py-2 text-xs rounded bg-gray-100 hover:bg-gray-200" onclick="unassignSlot('${pos}', ${idx}, event)">제거</button>`:''}
        ${inSlot?`<button class="px-3 py-2 text-xs rounded bg-blue-100 hover:bg-blue-200" onclick="startSwap('${pos}', ${idx})">${state.swapBuffer?'스왑취소':'스왑시작'}</button>`:''}
      </div>
      <div class="max-h-[50vh] overflow-auto grid grid-cols-2 gap-2">
        ${candidates.map(p=>`
          <button class="p-2 rounded border text-left hover:bg-blue-50"
                  onclick="${state.swapBuffer ? `finishSwap(${p.id})` : `assignToSlot(${p.id})`}">
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium">${p.name}</span>
              <span class="text-[10px] text-gray-500">${p.position} (${quartersPlayedCount(p.id)}/4)</span>
            </div>
          </button>
        `).join('')}
        ${candidates.length===0?`<div class="col-span-2 text-center text-sm text-gray-500 py-6">후보가 없습니다</div>`:''}
      </div>
    </div>
  </div>`;
}

/* ================== PLAYERS PAGE ================== */
function createPlayers(){
  const q = state.playerSearch.trim().toLowerCase();
  const list = q ? state.players.filter(p=>p.name.toLowerCase().includes(q)) : state.players;
  return `
  <div class="space-y-4 sm:space-y-6">
    <div class="bg-white p-4 rounded-lg shadow-md">
      <div class="flex flex-col sm:flex-row sm:items-center gap-3">
        <label class="bg-gray-800 text-white px-3 py-2 rounded-lg cursor-pointer text-xs sm:text-sm flex items-center">
          ${icons.upload}<span class="ml-1">JSON 불러오기</span>
          <input id="membersFile" type="file" accept=".json" class="hidden" onchange="importMembersFile(event)">
        </label>
        <button onclick="downloadBackup()" class="bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-lg text-xs sm:text-sm flex items-center">
          ${icons.download}<span class="ml-1">데이터 백업</span>
        </button>
        <div class="sm:ml-auto w-full sm:w-auto">
          <input class="border rounded-lg px-3 py-2 w-full sm:w-64 text-sm" placeholder="선수 이름 검색" value="${state.playerSearch}" oninput="setState({playerSearch:this.value})">
        </div>
      </div>
    </div>

    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3 gap-2">
        <h3 class="text-base sm:text-lg font-semibold">출석 체크</h3>
        <div class="flex items-center gap-4">
          <div class="text-xs sm:text-sm text-gray-600">출석: ${state.players.filter(p=>p.isPresent).length}명</div>
          <button onclick="clearAllAttendance()" class="text-red-500 hover:text-red-700 text-xs">전체 해제</button>
        </div>
      </div>

      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 sm:gap-3">
        ${list.map(p=>`
          <button onclick="toggleAttendance(${p.id})"
                  class="p-2 sm:p-3 rounded-lg border text-left transition-colors ${p.isPresent?'bg-green-50 border-green-300 text-green-800':'bg-gray-50 border-gray-300 text-gray-600 hover:bg-gray-100'}">
            <div class="flex items-center justify-between">
              <span class="font-medium text-xs sm:text-sm">${p.name}</span>
              <span class="text-[11px] opacity-75">${p.position}</span>
            </div>
            <div class="text-[11px] text-gray-500 mt-1">(쿼터: ${quartersPlayedCount(p.id)}/4)</div>
            ${p.isPresent?'<div class="text-xs text-green-600 mt-1">✓ 출석</div>':''}
          </button>`).join('')}
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-md">
      <h3 class="text-base sm:text-lg font-semibold p-4 sm:p-6 border-b">선수 기록</h3>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">이름</th>
              <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">포지션</th>
              <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">쿼터</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            ${state.players.map(p=>`
              <tr class="hover:bg-gray-50">
                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-medium text-gray-900">${p.name}</td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap">
                  <span class="px-2 py-1 text-xs rounded-full ${
                    p.position==="FW"?"bg-red-100 text-red-800":
                    p.position==="MF"?"bg-blue-100 text-blue-800":
                    p.position==="DF"?"bg-green-100 text-green-800":"bg-purple-100 text-purple-800"}">${p.position}</span>
                </td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm">${quartersPlayedCount(p.id)}/4</td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>
    </div>
  </div>`;
}

/* ================== BOTTOM SHEET (선수 선택) ================== */
function createBottomSheet(){
  if(!state.ui.pickerOpen) return '';
  const pos = state.ui.pickerPos, idx = state.ui.pickerSlot;
  const inSlot = state.formation[pos][idx];
  const assignedIds = new Set(Object.values(state.formation).flat().filter(Boolean).map(p=>p.id));
  const q = state.ui.pickerSearch.trim().toLowerCase();
  const candidates = state.players
    .filter(p=>p.isPresent)
    .filter(p=> !assignedIds.has(p.id) || (inSlot && p.id===inSlot.id))
    .filter(p=> p.name.toLowerCase().includes(q));

  return `
  <div class="fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/30" onclick="closePicker()"></div>
    <div class="absolute left-0 right-0 bottom-0 bg-white rounded-t-2xl shadow-2xl p-4 pt-3">
      <div class="flex items-center justify-between mb-2">
        <div class="text-sm text-gray-600">슬롯: <b>${pos.toUpperCase()} ${idx+1}</b></div>
        <button class="text-gray-500 text-sm" onclick="closePicker()">닫기</button>
      </div>
      <div class="flex items-center gap-2 mb-3">
        <input class="border rounded-lg px-3 py-2 w-full text-sm" placeholder="이름 검색" value="${state.ui.pickerSearch}"
               oninput="setState({ ui:{...state.ui, pickerSearch:this.value} })">
        ${inSlot?`<button class="px-3 py-2 text-xs rounded bg-gray-100 hover:bg-gray-200" onclick="unassignSlot('${pos}', ${idx}, event)">제거</button>`:''}
        ${inSlot?`<button class="px-3 py-2 text-xs rounded bg-blue-100 hover:bg-blue-200" onclick="startSwap('${pos}', ${idx})">${state.swapBuffer?'스왑취소':'스왑시작'}</button>`:''}
      </div>
      <div class="max-h-[50vh] overflow-auto grid grid-cols-2 gap-2">
        ${candidates.map(p=>`
          <button class="p-2 rounded border text-left hover:bg-blue-50"
                  onclick="${state.swapBuffer ? `finishSwap(${p.id})` : `assignToSlot(${p.id})`}">
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium">${p.name}</span>
              <span class="text-[10px] text-gray-500">${p.position} (${quartersPlayedCount(p.id)}/4)</span>
            </div>
          </button>
        `).join('')}
        ${candidates.length===0?`<div class="col-span-2 text-center text-sm text-gray-500 py-6">후보가 없습니다</div>`:''}
      </div>
    </div>
  </div>`;
}

/* ================== TOAST ================== */
let toastTimer=null;
function toast(msg){
  setState({saveStatus:msg});
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>setState({saveStatus:""}), 1400);
}

/* ================== START ================== */
document.addEventListener('DOMContentLoaded', ()=>{ loadData(); });

</script>
</body>
</html>
