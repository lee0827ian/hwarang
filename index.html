<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>í™”ë‘FC ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- í¬ë©”ì´ì…˜ ìº¡ì²˜ìš© -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body { margin:0; padding:0; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; }
    .icon { display:inline-block; width:1rem; height:1rem; vertical-align:middle; }
    .icon-lg { width:1.5rem; height:1.5rem; }
    @media (min-width: 640px) { .icon-lg { width:2rem; height:2rem; } }

    /* ===== í¬ë©”ì´ì…˜ ê²½ê¸°ì¥ ===== */
    .pitch {
      position: relative;
      min-height: 400px;
      background: linear-gradient(#bfe3bf, #9bd49b);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,0.6);
    }
    @media (min-width: 640px) { .pitch { min-height: 620px; } }
    .pitch .half-line { position:absolute; top:50%; left:0; right:0; height:2px; background:rgba(255,255,255,0.9); transform: translateY(-50%); }
    .pitch .center-circle { position:absolute; top:50%; left:50%; width:100px; height:100px; border:2px solid rgba(255,255,255,0.9); border-radius:50%; transform:translate(-50%,-50%); }
    @media (min-width: 640px) { .pitch .center-circle { width:140px; height:140px; } }
    .pitch .center-dot { position:absolute; top:50%; left:50%; width:6px; height:6px; background:#fff; border-radius:50%; transform:translate(-50%,-50%); }
    @media (min-width: 640px) { .pitch .center-dot { width:8px; height:8px; } }
    .pitch .box { position:absolute; left:50%; width:180px; height:80px; border:2px solid rgba(255,255,255,0.9); transform: translateX(-50%); background: rgba(255,255,255,0.06); }
    @media (min-width: 640px) { .pitch .box { width:240px; height:120px; } }
    .pitch .box.top { top:10px; } .pitch .box.bottom { bottom:10px; }

    /* ë“œë˜ê·¸ ì‹œê° íš¨ê³¼ */
    .player-chip.dragging { opacity: .55; }
    .drop-slot.drag-over { outline: 2px dashed rgba(59,130,246,.9); outline-offset: 4px; }

    /* ëª¨ë°”ì¼ ë„¤ë¹„ê²Œì´ì…˜ ìŠ¤í¬ë¡¤ */
    .nav-scroll { scrollbar-width: none; -ms-overflow-style: none; }
    .nav-scroll::-webkit-scrollbar { display: none; }
  </style>
</head>
<body>

<div id="root"></div>

<script>
/* -------------------- ê³µí†µ ìœ í‹¸ -------------------- */
function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }
function getEmptyFormation(){
  return {
    gk: [null],
    def: [null, null, null, null, null],
    dmf: [null, null, null],
    cmf: [null, null, null, null],
    amf: [null, null, null],
    fw: [null, null]
  };
}

/* -------------------- ì•± ìƒíƒœ (4ì¿¼í„° ì§€ì›) -------------------- */
let state = {
  activeTab: "dashboard",
  players: [],
  matches: [],
  // ì¿¼í„°ë³„ í¬ë©”ì´ì…˜
  formations: [getEmptyFormation(), getEmptyFormation(), getEmptyFormation(), getEmptyFormation()],
  currentQuarter: 1, // 1~4
  // ì €ì¥í•œ ì¿¼í„° ì´ë¯¸ì§€ (dataURL), ì¸ë±ìŠ¤: 0~3
  quarterImages: [null, null, null, null],

  newMatch: { opponent:"", location:"", date:"", result:"", goals:0, conceded:0 },
  newPlayer: { name:"", position:"FW" },
  draggedPlayer: null,
  saveStatus: "",
  playerSearch: ""
};

// í¸ì˜ë¥¼ ìœ„í•´ í˜„ì¬ ì¿¼í„° í¬ë©”ì´ì…˜ getter
function currentFormation(){ return state.formations[state.currentQuarter-1]; }

// í¬ì§€ì…˜ ë¼ë²¨
const positionLabels = {
  gk: ['GK'],
  def: ['LB', 'CB', 'CB', 'CB', 'RB'],
  dmf: ['DMF', 'DMF', 'DMF'],
  cmf: ['LM', 'CM', 'CM', 'RM'],
  amf: ['LW', 'AM', 'RW'],
  fw: ['SS', 'ST']
};

/* -------------------- ì´ˆê¸° ê²½ê¸° ë°ì´í„° -------------------- */
const initialMatches = [
  { id:1, opponent:"JK FC", location:"í•­ê³µëŒ€í•™êµ", date:"2024-08-15", result:"W", score:"3-1", goals:3, conceded:1 },
  { id:2, opponent:"ë¸”ë£¨ ìœ ë‚˜ì´í‹°ë“œ", location:"ì›”ë“œì»µê²½ê¸°ì¥", date:"2024-08-10", result:"L", score:"1-2", goals:1, conceded:2 }
];

/* -------------------- ì•„ì´ì½˜ -------------------- */
const icons = {
  plus:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>',
  users:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20v-2a4 4 0 00-4-4H7a4 4 0 00-4 4v2m14 0h3v-2a7 7 0 00-7-7M9 7a4 4 0 118 0 4 4 0 01-8 0z"/></svg>',
  calendar:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12"/></svg>',
  barChart:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19V10m-4 9V7m8 12v-4m4 4V4"/></svg>',
  target:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" stroke-width="2"/><circle cx="12" cy="12" r="5" stroke-width="2"/></svg>',
  shield:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 22s8-3 8-10V6l-8-4-8 4v6c0 7 8 10 8 10z"/></svg>',
  save:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 01-2 2H6a2 2 0 01-2-2V7a2 2 0 012-2h3"/></svg>',
  upload:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1M8 12l4-4 4 4M12 8v8"/></svg>',
  download:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1M8 12l4 4 4-4M12 16V4"/></svg>',
  refresh:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>',
  camera:'<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h4l2-3h6l2 3h4v12H3z"/><circle cx="12" cy="13" r="4" stroke-width="2"/></svg>'
};

/* -------------------- í„°ì¹˜ ë“œë˜ê·¸ -------------------- */
let touchData = { isDragging:false, draggedElement:null, draggedPlayer:null, startX:0, startY:0, offsetX:0, offsetY:0 };

/* -------------------- ë Œë”/ìƒíƒœ -------------------- */
function render(){ document.getElementById('root').innerHTML = createApp(); }
function setState(newState){ state = {...state, ...newState}; render(); autosave(); }

/* -------------------- ì´ë¦„ ì •ë¦¬ -------------------- */
function sanitizeName(raw){
  if(!raw) return "";
  let s = String(raw).trim();
  s = s.replace(/^í™”ë‘[\s_\-]?/i, "");
  s = s.replace(/\s{2,}/g, " ");
  s = s.replace(/[^\p{L}\p{N}\s._-]/gu, "");
  return s.trim();
}

/* -------------------- ì €ì¥/ë¡œë“œ -------------------- */
async function loadData(){
  const saved = localStorage.getItem('soccerTeamData');
  const savedData = saved ? safeJSON(saved, null) : null;

  if(savedData){
    setState({
      players: savedData.players || [],
      matches: savedData.matches || initialMatches,
      formations: savedData.formations && savedData.formations.length===4 ? savedData.formations : [getEmptyFormation(),getEmptyFormation(),getEmptyFormation(),getEmptyFormation()],
      currentQuarter: savedData.currentQuarter || 1,
      quarterImages: savedData.quarterImages || [null,null,null,null],
      saveStatus:"âœ“ ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜´"
    });
    setTimeout(()=>setState({saveStatus:""}),1500);
  }else{
    setState({ players: [], matches: initialMatches });
  }

  // members.json ë³‘í•© (ìºì‹œ ë°©ì§€)
  try{
    const res = await fetch('members.json?v=' + Date.now(), { cache: 'no-store' });
    if(res.ok){
      const json = await res.json();
      const names = Array.isArray(json) ? json : (json && Array.isArray(json.members)) ? json.members : [];
      const cleaned = names.map(sanitizeName).filter(Boolean);

      const existingByName = new Map(state.players.map(p=>[p.name, p]));
      const merged = [];
      cleaned.forEach(name=>{
        if(existingByName.has(name)){ merged.push(existingByName.get(name)); existingByName.delete(name); }
        else{
          merged.push({ id: Date.now()+Math.random(), name, position:"MF", goals:0, assists:0, attendance:0, isPresent:false });
        }
      });
      existingByName.forEach(v=>merged.push(v));

      setState({ players: merged, saveStatus:"âœ“ members.json ì—°ë™ë¨" });
      setTimeout(()=>setState({saveStatus:""}),1500);
    }
  }catch(e){
    console.log('members.json ë¡œë“œ ì‹¤íŒ¨(ì˜µì…˜)');
  }
}
function safeJSON(s, fallback){ try{ return JSON.parse(s); }catch{ return fallback; } }

function autosave(){
  const data = { 
    players: state.players, 
    matches: state.matches, 
    formations: state.formations,
    currentQuarter: state.currentQuarter,
    quarterImages: state.quarterImages,
    savedAt: new Date().toISOString() 
  };
  localStorage.setItem('soccerTeamData', JSON.stringify(data));
}

function saveData(){ autosave(); setState({saveStatus:"âœ“ ì €ì¥ ì™„ë£Œ"}); setTimeout(()=>setState({saveStatus:""}),1500); }

function downloadBackup(){
  const data = { 
    players: state.players, matches: state.matches, 
    formations: state.formations,
    currentQuarter: state.currentQuarter,
    quarterImages: state.quarterImages,
    exportedAt: new Date().toISOString(), version:"1.4Q" 
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `hwarang-backup-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  setState({saveStatus:"âœ“ ë°±ì—… ë‹¤ìš´ë¡œë“œë¨"}); setTimeout(()=>setState({saveStatus:""}),1500);
}

/* -------------------- members.json ìƒˆë¡œê³ ì¹¨ -------------------- */
async function reloadMembers(){
  setState({saveStatus:"ğŸ”„ members.json ë‹¤ì‹œ ë¡œë“œ ì¤‘..."});
  try{
    const res = await fetch('members.json?v=' + Date.now(), { cache: 'no-store' });
    if(res.ok){
      const json = await res.json();
      const names = Array.isArray(json) ? json : (json && Array.isArray(json.members)) ? json.members : [];
      const cleaned = names.map(sanitizeName).filter(Boolean);

      const existingByName = new Map(state.players.map(p=>[p.name, p]));
      const merged = [];
      cleaned.forEach(name=>{
        if(existingByName.has(name)){ merged.push(existingByName.get(name)); existingByName.delete(name); }
        else{
          merged.push({ id: Date.now()+Math.random(), name, position:"MF", goals:0, assists:0, attendance:0, isPresent:false });
        }
      });
      existingByName.forEach(v=>merged.push(v));
      setState({ players: merged, saveStatus:"âœ“ members.json ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ" });
    } else {
      setState({saveStatus:"âŒ members.json ì—†ìŒ"});
    }
  }catch(e){
    setState({saveStatus:"âŒ members.json ë¡œë“œ ì‹¤íŒ¨"});
  }
  setTimeout(()=>setState({saveStatus:""}), 2000);
}

/* -------------------- ì™¸ë¶€ JSON ì„í¬íŠ¸ -------------------- */
function importMembersFile(ev){
  const file = ev.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = (e)=>{
    try{
      const json = JSON.parse(e.target.result);
      const arr = Array.isArray(json) ? json : Array.isArray(json.members) ? json.members : null;
      if(!arr){ alert("ì§€ì› í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. ë°°ì—´ ë˜ëŠ” {members:[...]}"); return; }
      const cleaned = arr.map(sanitizeName).filter(n=>n);
      const existingByName = new Map(state.players.map(p=>[p.name,p]));
      const merged = [];
      cleaned.forEach((name)=>{
        if(existingByName.has(name)){ merged.push(existingByName.get(name)); existingByName.delete(name); }
        else{
          merged.push({ id: Date.now()+Math.random(), name, position:"MF", goals:0, assists:0, attendance:0, isPresent:false });
        }
      });
      existingByName.forEach(v=>merged.push(v));
      setState({ players: merged, saveStatus:"âœ“ JSON íŒŒì¼ ë°˜ì˜ë¨" });
      setTimeout(()=>setState({saveStatus:""}),1500);
    }catch(err){
      alert("JSON íŒŒì‹± ì‹¤íŒ¨: "+err.message);
    } finally { ev.target.value=""; }
  };
  reader.readAsText(file);
}

/* -------------------- ë“œë˜ê·¸&ë“œë¡­ (í˜„ì¬ ì¿¼í„° ëŒ€ìƒ) -------------------- */
function handleDragStart(ev, playerId){
  const player = state.players.find(p=>p.id===playerId);
  state.draggedPlayer = player;
  ev.dataTransfer.effectAllowed = "move";
  ev.currentTarget.classList.add("dragging");
}
function handleDragEnd(ev){ ev.currentTarget.classList.remove("dragging"); state.draggedPlayer = null; }
function handleDragOver(ev){ ev.preventDefault(); ev.dataTransfer.dropEffect = "move"; ev.currentTarget.classList.add("drag-over"); }
function handleDragLeave(ev){ ev.currentTarget.classList.remove("drag-over"); }

function handleDrop(ev, position, slotIndex){
  ev.preventDefault();
  ev.currentTarget.classList.remove("drag-over");
  const dragged = state.draggedPlayer;
  if(!dragged) return;

  const formation = deepClone(currentFormation());

  // í•´ë‹¹ ìŠ¬ë¡¯ ë¹„ì–´ìˆì–´ì•¼ í•¨
  if(formation[position][slotIndex] !== null) return;

  // í˜„ì¬ ì¿¼í„° ë‚´ì—ì„œ ê¸°ì¡´ ìœ„ì¹˜ ì œê±°
  Object.entries(formation).forEach(([pos, slots])=>{
    slots.forEach((player, idx)=>{
      if(player && player.id===dragged.id){ formation[pos][idx]=null; }
    });
  });

  formation[position][slotIndex] = dragged;

  const formations = deepClone(state.formations);
  formations[state.currentQuarter-1] = formation;
  setState({ formations });
}

/* ----- í„°ì¹˜ DnD ----- */
function handleTouchStart(ev, playerId){
  ev.preventDefault();
  const touch = ev.touches[0];
  const player = state.players.find(p=>p.id===playerId);
  touchData.isDragging = true;
  touchData.draggedElement = ev.currentTarget;
  touchData.draggedPlayer = player;
  const rect = ev.currentTarget.getBoundingClientRect();
  touchData.offsetX = touch.clientX - rect.left;
  touchData.offsetY = touch.clientY - rect.top;

  ev.currentTarget.classList.add("dragging");
  ev.currentTarget.style.position = "fixed";
  ev.currentTarget.style.zIndex = "1000";
  ev.currentTarget.style.pointerEvents = "none";

  document.addEventListener('touchmove', handleTouchMove, {passive:false});
  document.addEventListener('touchend', handleTouchEnd);
}
function handleTouchMove(ev){
  if(!touchData.isDragging) return;
  ev.preventDefault();
  const touch = ev.touches[0];
  const el = touchData.draggedElement;
  el.style.left = (touch.clientX - touchData.offsetX) + 'px';
  el.style.top  = (touch.clientY - touchData.offsetY) + 'px';

  document.querySelectorAll('.drop-slot').forEach(s=>s.classList.remove('drag-over'));
  const below = document.elementFromPoint(touch.clientX, touch.clientY);
  const drop = below?.closest('.drop-slot');
  if(drop && drop.dataset.position && drop.dataset.slotIndex !== undefined){
    const pos = drop.dataset.position; const idx = +drop.dataset.slotIndex;
    if(currentFormation()[pos][idx] === null){ drop.classList.add('drag-over'); }
  }
}
function handleTouchEnd(ev){
  if(!touchData.isDragging) return;
  const touch = ev.changedTouches[0];
  const below = document.elementFromPoint(touch.clientX, touch.clientY);
  const drop = below?.closest('.drop-slot');

  if(drop && touchData.draggedPlayer){
    const pos = drop.dataset.position; const idx = +drop.dataset.slotIndex;
    if(pos !== undefined && idx !== undefined){
      const formation = deepClone(currentFormation());
      if(formation[pos][idx] === null){
        // ì œê±° í›„ ë°°ì¹˜
        Object.entries(formation).forEach(([p, slots])=>{
          slots.forEach((pl, i)=>{ if(pl && pl.id===touchData.draggedPlayer.id){ formation[p][i]=null; }});
        });
        formation[pos][idx] = touchData.draggedPlayer;
        const formations = deepClone(state.formations);
        formations[state.currentQuarter-1] = formation;
        setState({ formations });
      }
    }
  }

  if(touchData.draggedElement){
    touchData.draggedElement.classList.remove("dragging");
    Object.assign(touchData.draggedElement.style, {position:"", zIndex:"", pointerEvents:"", left:"", top:""});
  }
  document.querySelectorAll('.drop-slot').forEach(s=>s.classList.remove('drag-over'));
  document.removeEventListener('touchmove', handleTouchMove);
  document.removeEventListener('touchend', handleTouchEnd);
  touchData = { isDragging:false, draggedElement:null, draggedPlayer:null, startX:0, startY:0, offsetX:0, offsetY:0 };
}

/* -------------------- ì„ ìˆ˜/ì¶œì„ -------------------- */
function addPlayer(){
  const name = sanitizeName(state.newPlayer.name);
  if(!name) return;
  setState({
    players: [...state.players, { id:Date.now(), name, position: state.newPlayer.position || "FW", goals:0, assists:0, attendance:0, isPresent:false }],
    newPlayer: { name:"", position:"FW" }
  });
}
function toggleAttendance(id){
  setState({ players: state.players.map(p=> p.id===id ? {...p, isPresent:!p.isPresent} : p ) });
}
function clearAllAttendance(){ setState({ players: state.players.map(p=>({...p, isPresent:false})) }); }
function setActiveTab(tab){ setState({activeTab:tab}); }
function updateNewPlayer(field, value){ setState({ newPlayer: { ...state.newPlayer, [field]: value } }); }
function updateNewMatch(field, value){ setState({ newMatch: { ...state.newMatch, [field]: value } }); }
function getPresentPlayers(){ return state.players.filter(p=>p.isPresent); }

/* -------------------- ê²½ê¸° -------------------- */
function addMatch(){
  const m = state.newMatch;
  if(!(m.opponent && m.location && m.date)) return;
  const score = `${m.goals}-${m.conceded}`;
  const newM = { ...m, id: Date.now(), score, goals: parseInt(m.goals)||0, conceded: parseInt(m.conceded)||0 };
  setState({ matches:[...state.matches, newM], newMatch:{opponent:"",location:"",date:"",result:"",goals:0,conceded:0} });
}

/* -------------------- í†µê³„ -------------------- */
function teamStats(){
  const ms = state.matches;
  const matches = ms.length;
  const wins = ms.filter(m=>m.result==="W").length;
  const draws = ms.filter(m=>m.result==="D").length;
  const losses = ms.filter(m=>m.result==="L").length;
  const goalsFor = ms.reduce((s,m)=>s+m.goals,0);
  const goalsAgainst = ms.reduce((s,m)=>s+m.conceded,0);
  const cleanSheets = ms.filter(m=>m.conceded===0).length;
  return { matches, wins, draws, losses, goalsFor, goalsAgainst, cleanSheets,
    winRate: matches?((wins/matches)*100).toFixed(1):0,
    avgGoalsFor: matches?(goalsFor/matches).toFixed(2):0,
    avgGoalsAgainst: matches?(goalsAgainst/matches).toFixed(2):0,
    cleanSheetRate: matches?((cleanSheets/matches)*100).toFixed(1):0 };
}

/* -------------------- ì¿¼í„° ê´€ë ¨ -------------------- */
// í˜„ì¬ ì¿¼í„° ì „í™˜
function setQuarter(q){
  if(q<1||q>4) return;
  setState({ currentQuarter: q });
}
// í˜„ì¬ ì¿¼í„° í¬ë©”ì´ì…˜ ìŠ¬ë¡¯ì—ì„œ ì œê±°
function removeFromFormationSlot(position, slotIndex){
  const formations = deepClone(state.formations);
  const f = formations[state.currentQuarter-1];
  f[position][slotIndex] = null;
  setState({ formations });
}
// í˜„ì¬ ì¿¼í„°ë§Œ ì´ˆê¸°í™”
function clearCurrentQuarter(){
  const formations = deepClone(state.formations);
  formations[state.currentQuarter-1] = getEmptyFormation();
  setState({ formations });
}
// ì „ì²´ ì¿¼í„° ì´ˆê¸°í™”
function clearAllQuarters(){
  setState({ formations: [getEmptyFormation(),getEmptyFormation(),getEmptyFormation(),getEmptyFormation()], quarterImages:[null,null,null,null] });
}

// ì„ ìˆ˜ë³„ ëª‡ ì¿¼í„° ë›´ê±´ì§€ ê³„ì‚°
function playedQuartersCount(playerId){
  let c = 0;
  state.formations.forEach(f=>{
    const placed = Object.values(f).flat().some(p=>p && p.id===playerId);
    if(placed) c++;
  });
  return c;
}

// í˜„ì¬ ì¿¼í„° í¬ë©”ì´ì…˜ì„ ì´ë¯¸ì§€ë¡œ ì €ì¥í•˜ê³ , ë‹¤ìŒ ì¿¼í„°ë¡œ ì´ë™
async function saveQuarterAsImage(){
  const pitch = document.querySelector('.pitch');
  if(!pitch){ setState({saveStatus:"âŒ ìº¡ì²˜ ëŒ€ìƒ ì—†ìŒ"}); return; }

  // ìµœì†Œ í•œ ëª…ì´ë¼ë„ ë°°ì¹˜ë˜ì—ˆëŠ”ì§€ ì²´í¬(ì„ íƒ)
  const filled = Object.values(currentFormation()).flat().filter(v=>v!==null).length;
  if(filled===0){
    if(!confirm("ë°°ì¹˜ëœ ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ì €ì¥í• ê¹Œìš”?")) return;
  }

  setState({saveStatus:"ğŸ“¸ ì¿¼í„° ì´ë¯¸ì§€ ì €ì¥ ì¤‘..."});
  try{
    const canvas = await html2canvas(pitch, {backgroundColor:null, scale:2});
    const dataUrl = canvas.toDataURL('image/png');

    const quarterImages = [...state.quarterImages];
    quarterImages[state.currentQuarter-1] = dataUrl;

    setState({ quarterImages, saveStatus: `âœ“ ${state.currentQuarter}ì¿¼í„° ì´ë¯¸ì§€ ì €ì¥ ì™„ë£Œ` });

    // ë‹¤ìŒ ì¿¼í„°ë¡œ ì´ë™(4ì¿¼í„°ë©´ ìœ ì§€)
    if(state.currentQuarter < 4){
      setQuarter(state.currentQuarter + 1);
    }
  }catch(e){
    setState({saveStatus:"âŒ ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨"});
  }
  setTimeout(()=>setState({saveStatus:""}),1500);
}

/* -------------------- UI -------------------- */
function createApp(){
  return `
  <div class="min-h-screen bg-gray-50">
    ${createNav()}
    <main class="max-w-7xl mx-auto py-4 sm:py-6 px-3 sm:px-4 lg:px-8">
      ${state.activeTab==='dashboard'? createDashboard():''}
      ${state.activeTab==='matches'? createMatches():''}
      ${state.activeTab==='formation'? createFormation():''}
      ${state.activeTab==='players'? createPlayers():''}
    </main>
  </div>`;
}

function createNav(){
  const tabs = [
    {id:'dashboard', name:'ëŒ€ì‹œë³´ë“œ', shortName:'ëŒ€ì‹œë³´ë“œ', icon:'barChart'},
    {id:'matches', name:'ê²½ê¸° ê¸°ë¡', shortName:'ê²½ê¸°', icon:'calendar'},
    {id:'formation', name:'í¬ë©”ì´ì…˜', shortName:'í¬ë©”ì´ì…˜', icon:'target'},
    {id:'players', name:'ì„ ìˆ˜ ê´€ë¦¬', shortName:'ì„ ìˆ˜', icon:'users'}
  ];
  return `
  <nav class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-8">
      <div class="flex space-x-2 sm:space-x-8 overflow-x-auto nav-scroll">
        ${tabs.map(t=>`
          <button onclick="setActiveTab('${t.id}')" class="py-3 sm:py-4 px-2 sm:px-1 border-b-2 font-medium text-xs sm:text-sm whitespace-nowrap flex items-center flex-shrink-0 ${state.activeTab===t.id?'border-blue-500 text-blue-600':'border-transparent text-gray-500 hover:text-gray-700'}">
            ${icons[t.icon]} 
            <span class="ml-1">${t.name}</span>
          </button>`).join('')}
      </div>
    </div>
  </nav>`;
}

function createDashboard(){
  const s = teamStats();
  const top = [...state.players].sort((a,b)=>b.goals-a.goals).slice(0,5);
  return `
  <div class="space-y-4 sm:space-y-6">
    <div class="bg-gradient-to-r from-green-500 to-blue-600 text-white p-4 sm:p-6 rounded-lg">
      <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 sm:gap-4">
        <div>
          <h1 class="text-2xl sm:text-3xl font-bold mb-1 sm:mb-2">âš½ í™”ë‘ FC</h1>
          <p class="text-sm sm:text-lg opacity-90">ì¶•êµ¬ëŠ” ë‚˜ì˜ ì‚¶ì´ë‹¤</p>
        </div>
        <div class="flex flex-col sm:flex-row gap-2">
          <button onclick="reloadMembers()" class="bg-white/20 hover:bg-white/30 px-3 py-2 rounded-lg flex items-center justify-center text-sm transition-colors">
            ${icons.refresh} <span class="ml-1">ìƒˆë¡œê³ ì¹¨</span>
          </button>
          <button onclick="saveData()" class="bg-white/20 hover:bg-white/30 px-3 py-2 rounded-lg flex items-center justify-center text-sm transition-colors">
            ${icons.save} <span class="ml-1">ì €ì¥</span>
          </button>
          <button onclick="downloadBackup()" class="bg-white/20 hover:bg-white/30 px-3 py-2 rounded-lg flex items-center justify-center text-sm transition-colors">
            ${icons.download} <span class="ml-1">ë°±ì—…</span>
          </button>
        </div>
      </div>
      ${state.saveStatus?`<div class="mt-3 text-sm opacity-90 bg-white/10 px-3 py-2 rounded-lg">${state.saveStatus}</div>`:''}
    </div>

    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
      ${statCard("ê²½ê¸°ìˆ˜", s.matches, "calendar","text-green-500")}
      ${statCard("ìŠ¹ë¥ ", s.winRate+"%", "barChart","text-blue-500")}
      ${statCard("ë“ì ", s.goalsFor, "target","text-red-500")}
      ${statCard("ì‹¤ì ", s.goalsAgainst, "shield","text-purple-500")}
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
      <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
        <h3 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4 flex items-center">${icons.barChart} <span class="ml-1">íŒ€ ìƒì„¸ ê¸°ë¡</span></h3>
        <div class="space-y-2 sm:space-y-3">
          ${row("ìŠ¹/ë¬´/íŒ¨", `${s.wins}/${s.draws}/${s.losses}`)}
          ${row("ê²½ê¸°ë‹¹ ë“ì ", s.avgGoalsFor)}
          ${row("ê²½ê¸°ë‹¹ ì‹¤ì ", s.avgGoalsAgainst)}
          ${row("ë¬´ì‹¤ì  ê²½ê¸°", `${s.cleanSheets}ê²½ê¸°`)}
          ${row("ë¬´ì‹¤ì  ë¹„ìœ¨", `${s.cleanSheetRate}%`)}
        </div>
      </div>

      <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
        <h3 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4 flex items-center">${icons.target} <span class="ml-1">Top ë“ì ì</span></h3>
        <div class="space-y-2 sm:space-y-3">
          ${top.length ? top.map((p,i)=>`
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <span class="w-5 h-5 sm:w-6 sm:h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs sm:text-sm font-semibold mr-2 sm:mr-3">${i+1}</span>
                <span class="text-sm sm:text-base">${p.name}</span>
                <span class="ml-1 sm:ml-2 text-xs text-gray-500">(${p.position})</span>
              </div>
              <span class="text-sm sm:text-base font-semibold">${p.goals}ê³¨</span>
            </div>`).join('') : '<div class="text-gray-500 text-sm text-center py-4">ë“ì  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>'}
        </div>
      </div>
    </div>
  </div>`;
}
function statCard(label,value,icon,color){
  return `
  <div class="bg-white p-3 sm:p-4 rounded-lg shadow-md border-l-4 border-gray-100">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-gray-600 text-xs sm:text-sm">${label}</p>
        <p class="text-lg sm:text-2xl font-bold text-gray-800">${value}</p>
      </div>
      <div class="icon-lg ${color} flex-shrink-0">${icons[icon]}</div>
    </div>
  </div>`}
function row(l,v){ return `<div class="flex justify-between text-sm sm:text-base"><span class="text-gray-600">${l}</span><span class="font-semibold">${v}</span></div>`}

function createMatches(){
  return `
  <div class="space-y-4 sm:space-y-6">
    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
      <h3 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4">ìƒˆ ê²½ê¸° ì¶”ê°€</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
        <input class="border rounded-lg px-3 py-2 text-sm sm:text-base" placeholder="ìƒëŒ€íŒ€" value="${state.newMatch.opponent}" onchange="updateNewMatch('opponent', this.value)">
        <input class="border rounded-lg px-3 py-2 text-sm sm:text-base" placeholder="ê²½ê¸°ì¥" value="${state.newMatch.location}" onchange="updateNewMatch('location', this.value)">
        <input type="date" class="border rounded-lg px-3 py-2 text-sm sm:text-base" value="${state.newMatch.date}" onchange="updateNewMatch('date', this.value)">
        <select class="border rounded-lg px-3 py-2 text-sm sm:text-base" value="${state.newMatch.result}" onchange="updateNewMatch('result', this.value)">
          <option value="">ê²°ê³¼ ì„ íƒ</option><option value="W">ìŠ¹ë¦¬</option><option value="D">ë¬´</option><option value="L">íŒ¨</option>
        </select>
        <input type="number" class="border rounded-lg px-3 py-2 text-sm sm:text-base" placeholder="ë“ì " value="${state.newMatch.goals}" onchange="updateNewMatch('goals', parseInt(this.value)||0)">
        <input type="number" class="border rounded-lg px-3 py-2 text-sm sm:text-base" placeholder="ì‹¤ì " value="${state.newMatch.conceded}" onchange="updateNewMatch('conceded', parseInt(this.value)||0)">
      </div>
      <button onclick="addMatch()" class="mt-3 sm:mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center text-sm sm:text-base">
        ${icons.plus} <span class="ml-1">ê²½ê¸° ì¶”ê°€</span>
      </button>
    </div>

    <div class="bg-white rounded-lg shadow-md">
      <h3 class="text-base sm:text-lg font-semibold p-4 sm:p-6 border-b">ê²½ê¸° ê¸°ë¡</h3>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ë‚ ì§œ</th>
              <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ìƒëŒ€íŒ€</th>
              <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden sm:table-cell">ì¥ì†Œ</th>
              <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ê²°ê³¼</th>
              <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ìŠ¤ì½”ì–´</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            ${state.matches.map(m=>`
              <tr class="hover:bg-gray-50">
                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900">${m.date}</td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900">${m.opponent}</td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500 hidden sm:table-cell">${m.location}</td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap">
                  <span class="px-2 py-1 text-xs rounded-full ${m.result==='W'?'bg-green-100 text-green-800':m.result==='L'?'bg-red-100 text-red-800':'bg-yellow-100 text-yellow-800'}">
                    ${m.result==='W'?'ìŠ¹':m.result==='L'?'íŒ¨':'ë¬´'}
                  </span>
                </td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-medium">${m.score}</td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>
    </div>
  </div>`;
}

/* ===== í¬ë©”ì´ì…˜ (4ì¿¼í„° + ì´ë¯¸ì§€ ì €ì¥) ===== */
function createFormation(){
  const present = getPresentPlayers();
  const filledCount = Object.values(currentFormation()).flat().filter(v=>v!==null).length;

  // í˜„ì¬ ì¿¼í„°ì—ì„œ ì¶œì „ì—¬ë¶€ëŠ” ë³„ë„ì§€ë§Œ, ì¹©ì—ëŠ” (x/4)ë¡œ ì´ ì¿¼í„° ì¶œì „ ìˆ˜ í‘œì‹œ
  return `
  <div class="space-y-4 sm:space-y-6">
    <!-- ìƒë‹¨ ì»¨íŠ¸ë¡¤ -->
    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div class="flex items-center gap-2">
          <h3 class="text-base sm:text-lg font-semibold">í¬ë©”ì´ì…˜ (ì¿¼í„° ${state.currentQuarter}/4)</h3>
          <div class="flex gap-1">
            ${[1,2,3,4].map(q=>`
              <button onclick="setQuarter(${q})"
                class="px-2 py-1 text-xs rounded ${state.currentQuarter===q?'bg-blue-600 text-white':'bg-gray-100 hover:bg-gray-200'}">${q}Q</button>
            `).join('')}
          </div>
        </div>
        <div class="flex gap-2">
          <button onclick="clearCurrentQuarter()" class="px-3 py-2 text-xs sm:text-sm rounded bg-gray-600 text-white hover:bg-gray-700">í˜„ì¬ ì¿¼í„° ì´ˆê¸°í™”</button>
          <button onclick="clearAllQuarters()" class="px-3 py-2 text-xs sm:text-sm rounded bg-gray-500 text-white hover:bg-gray-600">ì „ì²´ ì¿¼í„° ì´ˆê¸°í™”</button>
          <button onclick="saveQuarterAsImage()" class="px-3 py-2 text-xs sm:text-sm rounded bg-blue-600 text-white hover:bg-blue-700 flex items-center">
            ${icons.camera} <span class="ml-1">ì €ì¥(ì´ë¯¸ì§€)</span>
          </button>
        </div>
      </div>
      ${state.saveStatus?`<div class="mt-2 text-xs sm:text-sm text-blue-700">${state.saveStatus}</div>`:''}
    </div>

    <!-- ì¶œì„ ì¸ì› -->
    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3 sm:mb-4 gap-2">
        <h4 class="text-sm sm:text-base font-semibold">ì¶œì„ ì¸ì›</h4>
        <div class="text-xs sm:text-sm text-gray-600">
          í˜„ì¬ ì¿¼í„° ë°°ì¹˜: ${filledCount}/11ëª…
        </div>
      </div>

      <div class="flex flex-wrap gap-2 mb-2">
        ${present.map(p=>{
          const placedThisQuarter = Object.values(currentFormation()).flat().some(pl => pl && pl.id===p.id);
          const quarterPlayed = playedQuartersCount(p.id);
          return `
          <div class="player-chip ${placedThisQuarter ? 'bg-gray-200 text-gray-500' : 'bg-blue-100 text-blue-800'} px-2 sm:px-3 py-1 sm:py-2 rounded-full text-xs sm:text-sm font-medium ${placedThisQuarter ? 'cursor-not-allowed' : 'cursor-move hover:bg-blue-200'} transition-colors flex items-center select-none"
               ${!placedThisQuarter ? 'draggable="true"' : ''}
               ${!placedThisQuarter ? `ondragstart="handleDragStart(event, ${p.id})"` : ''}
               ${!placedThisQuarter ? `ondragend="handleDragEnd(event)"` : ''}
               ${!placedThisQuarter ? `ontouchstart="handleTouchStart(event, ${p.id})"` : ''} style="touch-action:none;">
            <span class="mr-1">${p.name}</span>
            <span class="text-[10px] sm:text-xs opacity-75">(${p.position})</span>
            <span class="ml-1 text-[10px] sm:text-xs text-gray-600">(${quarterPlayed}/4)</span>
            ${placedThisQuarter ? '<span class="ml-1 text-[10px]">âœ“</span>' : ''}
          </div>`;
        }).join('')}
      </div>
      ${present.length===0 ? '<p class="text-gray-500 text-xs sm:text-sm">ì¶œì„í•œ ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. ì„ ìˆ˜ ê´€ë¦¬ íƒ­ì—ì„œ ì¶œì„ ì²´í¬ í›„ ë“œë˜ê·¸í•˜ì„¸ìš”.</p>' : ''}
    </div>

    <!-- ê²½ê¸°ì¥ -->
    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
      <div class="pitch">
        <div class="half-line"></div>
        <div class="center-circle"></div>
        <div class="center-dot"></div>
        <div class="box top"></div>
        <div class="box bottom"></div>

        <div class="relative h-full flex flex-col justify-between py-8 sm:py-16">
          ${createPositionRow('fw', 'ê³µê²©ìˆ˜', 'bg-red-500', currentFormation().fw)}
          ${createPositionRow('amf', 'ê³µê²©í˜• MF', 'bg-orange-500', currentFormation().amf)}
          ${createPositionRow('cmf', 'ì¤‘ì•™ MF', 'bg-blue-500', currentFormation().cmf)}
          ${createPositionRow('dmf', 'ìˆ˜ë¹„í˜• MF', 'bg-teal-500', currentFormation().dmf)}
          ${createPositionRow('def', 'ìˆ˜ë¹„ìˆ˜', 'bg-green-500', currentFormation().def)}
          ${createPositionRow('gk', 'ê³¨í‚¤í¼', 'bg-purple-500', currentFormation().gk)}
        </div>
      </div>
    </div>

    <!-- ì €ì¥ëœ ì¿¼í„° ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ -->
    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
      <h4 class="text-sm sm:text-base font-semibold mb-3">ì €ì¥ëœ ì¿¼í„° ì´ë¯¸ì§€</h4>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        ${[0,1,2,3].map(i=>{
          const img = state.quarterImages[i];
          return `
          <div class="border rounded-lg p-2 flex flex-col items-center justify-center">
            <div class="text-xs mb-1">${i+1}Q</div>
            ${img ? `<img src="${img}" alt="Q${i+1}" class="w-full rounded">`
                  : `<div class="w-full h-24 bg-gray-100 rounded flex items-center justify-center text-gray-400 text-xs">ì•„ì§ ì—†ìŒ</div>`}
          </div>`;
        }).join('')}
      </div>
    </div>
  </div>`;
}

function createPositionRow(position, label, color, slots){
  const labels = positionLabels[position];
  const spacing = position === 'def' ? 'space-x-1 sm:space-x-2' : 
                  position === 'dmf' ? 'space-x-4 sm:space-x-8' : 
                  position === 'cmf' ? 'space-x-2 sm:space-x-4' :
                  position === 'amf' ? 'space-x-4 sm:space-x-8' : 
                  'space-x-6 sm:space-x-12';
  return `
  <div class="flex justify-center ${spacing} min-h-[50px] sm:min-h-[68px] items-center">
    ${slots.map((player, idx) => `
      <div class="drop-slot flex flex-col items-center"
           data-position="${position}" 
           data-slot-index="${idx}"
           ondragover="handleDragOver(event)" 
           ondragleave="handleDragLeave(event)" 
           ondrop="handleDrop(event, '${position}', ${idx})">
        ${player ? `
          <div class="w-12 h-12 sm:w-16 sm:h-16 ${color} rounded-full flex items-center justify-center text-white text-xs font-bold shadow-md cursor-pointer relative"
               title="í´ë¦­í•˜ì—¬ ì œê±°" onclick="removeFromFormationSlot('${position}', ${idx})">
            <span class="text-center leading-tight px-1">${player.name}</span>
            <div class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full flex items-center justify-center text-xs text-white">Ã—</div>
          </div>
        ` : `
          <div class="w-12 h-12 sm:w-16 sm:h-16 border-2 border-dashed border-white/60 rounded-full flex items-center justify-center text-white/80 text-xs">
            <span class="text-center">ë¹ˆì¹¸</span>
          </div>
        `}
        <div class="text-white/90 text-xs mt-1 font-medium">${labels[idx]}</div>
      </div>
    `).join('')}
  </div>`;
}

/* ----- ì„ ìˆ˜ ê´€ë¦¬ íƒ­ (ê²€ìƒ‰ ì…ë ¥ì„ ì¶œì„ ì¹´ë“œ ì˜†ìœ¼ë¡œ ë¶™ì„) ----- */
function createPlayers(){
  const q = state.playerSearch.trim().toLowerCase();
  const list = q ? state.players.filter(p=>p.name.toLowerCase().includes(q)) : state.players;

  return `
  <div class="space-y-4 sm:space-y-6">

    <div class="bg-white p-4 rounded-lg shadow-md">
      <div class="flex flex-col sm:flex-row sm:items-center gap-3">
        <label class="bg-gray-800 text-white px-3 py-2 rounded-lg cursor-pointer text-xs sm:text-sm flex items-center">
          ${icons.upload} <span class="ml-1">JSON ë¶ˆëŸ¬ì˜¤ê¸°</span>
          <input id="membersFile" type="file" accept=".json" class="hidden" onchange="importMembersFile(event)">
        </label>

        <button onclick="downloadBackup()" class="bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-lg text-xs sm:text-sm flex items-center">
          ${icons.download} <span class="ml-1">ë°ì´í„° ë°±ì—…</span>
        </button>
      </div>
    </div>

    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3 gap-2">
        <h3 class="text-base sm:text-lg font-semibold">ì¶œì„ ì²´í¬</h3>
        <div class="flex items-center gap-3 w-full sm:w-auto">
          <input class="border rounded-lg px-3 py-2 w-full sm:w-64 text-sm" placeholder="ì„ ìˆ˜ ì´ë¦„ ê²€ìƒ‰"
                 value="${state.playerSearch}" oninput="setState({playerSearch:this.value})">
          <div class="text-xs sm:text-sm text-gray-600 whitespace-nowrap">
            ì¶œì„: ${state.players.filter(p=>p.isPresent).length}ëª…
          </div>
          <button onclick="clearAllAttendance()" class="text-red-500 hover:text-red-700 text-xs">ì „ì²´ í•´ì œ</button>
        </div>
      </div>

      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 sm:gap-3">
        ${list.map(p=>{
          const qCnt = playedQuartersCount(p.id);
          return `
          <button onclick="toggleAttendance(${p.id})"
                  class="p-2 sm:p-3 rounded-lg border text-left transition-colors ${p.isPresent?'bg-green-50 border-green-300 text-green-800':'bg-gray-50 border-gray-300 text-gray-600 hover:bg-gray-100'}">
            <div class="flex items-center justify-between">
              <span class="font-medium text-xs sm:text-sm">${p.name}</span>
              <span class="text-xs opacity-75">${p.position}</span>
            </div>
            <div class="text-[11px] text-gray-600 mt-1">(ì¶œì „ ${qCnt}/4)</div>
            ${p.isPresent?'<div class="text-xs text-green-600 mt-1">âœ“ ì¶œì„</div>':''}
          </button>`;
        }).join('')}
      </div>
    </div>

    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
      <h3 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4">ìƒˆ ì„ ìˆ˜ ì¶”ê°€</h3>
      <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
        <input class="border rounded-lg px-3 py-2 flex-1 text-sm" placeholder="ì„ ìˆ˜ ì´ë¦„"
               value="${state.newPlayer.name}" onchange="updateNewPlayer('name', this.value)">
        <select class="border rounded-lg px-3 py-2 text-sm" value="${state.newPlayer.position}" onchange="updateNewPlayer('position', this.value)">
          <option value="FW">ê³µê²©ìˆ˜</option><option value="MF">ë¯¸ë“œí•„ë”</option><option value="DF">ìˆ˜ë¹„ìˆ˜</option><option value="GK">ê³¨í‚¤í¼</option>
        </select>
        <button onclick="addPlayer()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center justify-center text-sm">
          ${icons.plus} <span class="ml-1">ì¶”ê°€</span>
        </button>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-md">
      <h3 class="text-base sm:text-lg font-semibold p-4 sm:p-6 border-b">ì„ ìˆ˜ ê¸°ë¡</h3>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì´ë¦„</th>
              <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">í¬ì§€ì…˜</th>
              <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden sm:table-cell">ë“ì </th>
              <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden sm:table-cell">ë„ì›€</th>
              <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì¶œì„</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            ${state.players.map(p=>`
              <tr class="hover:bg-gray-50">
                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-medium text-gray-900">${p.name}</td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap">
                  <span class="px-2 py-1 text-xs rounded-full ${
                    p.position==="FW"?"bg-red-100 text-red-800":
                    p.position==="MF"?"bg-blue-100 text-blue-800":
                    p.position==="DF"?"bg-green-100 text-green-800":"bg-purple-100 text-purple-800"}">${p.position}</span>
                </td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm hidden sm:table-cell">${p.goals}</td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm hidden sm:table-cell">${p.assists}</td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap">
                  <span class="px-2 py-1 text-xs rounded-full ${p.isPresent?'bg-green-100 text-green-800':'bg-gray-100 text-gray-600'}">${p.isPresent?'ì¶œì„':'ë¶ˆì°¸'}</span>
                </td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>
    </div>
  </div>`;
}

/* -------------------- ì‹œì‘ -------------------- */
document.addEventListener('DOMContentLoaded', ()=>{ loadData(); render(); });
</script>
</body>
</html>
